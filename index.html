<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú©ÛŒ Ø¨Ø±Ù Ù…ÛŒØ§Ø¯ØŸ | ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©ÛŒ</title>
    <meta name="description" content="Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø¯Ù‚ÛŒÙ‚ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ù Ùˆ Ø¢Ø¨â€ŒÙˆÙ‡ÙˆØ§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©ÛŒ Ø§ÛŒØ±Ø§Ù†">
    
    <!-- Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles & Tailwind Config -->
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Direction Helpers */
        .dir-ltr { direction: ltr; display: inline-block; unicode-bidi: isolate; }
        .num-font { font-feature-settings: "ss01"; }
        
        /* Custom Scrollbar */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Theme Classes */
        .theme-snow {
            --bg-main: #f0f9ff; /* sky-50 */
            --bg-card: rgba(255, 255, 255, 0.8);
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #475569; /* slate-600 */
            --accent: #0ea5e9; /* sky-500 */
            --border: #e0f2fe; /* sky-100 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .theme-sun {
            --bg-main: #fffbeb; /* amber-50 */
            --bg-card: rgba(255, 255, 255, 0.9);
            --text-primary: #451a03; /* amber-950 */
            --text-secondary: #92400e; /* amber-800 */
            --accent: #f59e0b; /* amber-500 */
            --border: #fef3c7; /* amber-100 */
            --card-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1);
        }

        .theme-night {
            --bg-main: #0f172a; /* slate-900 */
            --bg-card: rgba(30, 41, 59, 0.8); /* slate-800 */
            --text-primary: #f8fafc; /* slate-50 */
            --text-secondary: #94a3b8; /* slate-400 */
            --accent: #818cf8; /* indigo-400 */
            --border: #334155; /* slate-700 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* Fix modal text colors for night mode specifically */
        .theme-night #hourly-modal .glass-card, 
        .theme-night #hourly-modal .bg-white\/40,
        .theme-night #hourly-modal .bg-white\/30,
        .theme-night #hourly-modal .bg-white\/50 {
            background-color: rgba(30, 41, 59, 0.9);
            color: #f8fafc;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
        }

        .glass-card {
            background-color: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }

        .accent-text { color: var(--accent); }
        .accent-bg { background-color: var(--accent); }
        
        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
</head>
<body class="theme-snow min-h-screen flex flex-col">

    <!-- Header -->
    <header class="w-full px-6 py-6 flex justify-between items-center max-w-6xl mx-auto">
        <div class="flex items-center gap-3">
            <div class="p-2 rounded-xl accent-bg text-white shadow-lg animate-float">
                <i data-lucide="snowflake" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-2xl font-black tracking-tight">Ú©ÛŒ Ø¨Ø±Ù Ù…ÛŒØ§Ø¯ØŸ</h1>
                <p class="text-xs opacity-70 font-medium">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ ØªØ®ØµØµÛŒ Ù¾ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©ÛŒ</p>
            </div>
        </div>

        <!-- Theme Switcher -->
        <div class="flex bg-white/20 backdrop-blur-md rounded-full p-1 border border-current/10">
            <button onclick="setTheme('theme-sun')" class="p-2 rounded-full hover:bg-white/30 transition-colors" aria-label="ØªÙ… Ø¢ÙØªØ§Ø¨ÛŒ">
                <i data-lucide="sun" class="w-5 h-5"></i>
            </button>
            <button onclick="setTheme('theme-snow')" class="p-2 rounded-full hover:bg-white/30 transition-colors" aria-label="ØªÙ… Ø¨Ø±ÙÛŒ">
                <i data-lucide="cloud-snow" class="w-5 h-5"></i>
            </button>
            <button onclick="setTheme('theme-night')" class="p-2 rounded-full hover:bg-white/30 transition-colors" aria-label="ØªÙ… Ø´Ø¨">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-4 pb-12 max-w-6xl mx-auto w-full relative">
        
        <!-- Detailed Hourly Modal -->
        <div id="hourly-modal" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-in" onclick="closeModal(event)">
            <div class="glass-card w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-3xl p-6 shadow-2xl relative animate-float-up" onclick="event.stopPropagation()">
                
                <button onclick="closeModal()" class="absolute top-4 left-4 p-2 rounded-full hover:bg-black/5 transition-colors">
                    <i data-lucide="x" class="w-6 h-6 opacity-60"></i>
                </button>

                <div id="modal-content" class="flex flex-col gap-6">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>

        <!-- Selector -->
        <div class="flex flex-col items-center my-8 gap-6">
            <div class="glass-card rounded-2xl p-2 flex flex-wrap justify-center gap-2 shadow-sm">
                <button onclick="loadResort('tochal')" id="btn-tochal" class="resort-btn px-5 py-2 rounded-xl font-bold text-sm transition-all duration-200 bg-transparent opacity-60 hover:opacity-100">
                    ØªÙˆÚ†Ø§Ù„
                </button>
                <button onclick="loadResort('dizin')" id="btn-dizin" class="resort-btn px-5 py-2 rounded-xl font-bold text-sm transition-all duration-200 bg-transparent opacity-60 hover:opacity-100">
                    Ø¯ÛŒØ²ÛŒÙ†
                </button>
                <button onclick="loadResort('darbandsar')" id="btn-darbandsar" class="resort-btn px-5 py-2 rounded-xl font-bold text-sm transition-all duration-200 bg-transparent opacity-60 hover:opacity-100">
                    Ø¯Ø±Ø¨Ù†Ø¯Ø³Ø±
                </button>
            </div>

            <!-- Magic Button (Snowflake Style) -->
            <div class="flex flex-col items-center gap-4 w-full">
                <button onclick="askWhenSnow()" class="group relative flex items-center justify-center w-20 h-20 rounded-full accent-bg text-white shadow-xl hover:shadow-2xl transition-all hover:-translate-y-1 active:translate-y-0 hover:scale-110 z-10 ring-4 ring-white/30">
                    <div class="absolute inset-0 bg-white/20 rounded-full animate-ping opacity-20"></div>
                    <i data-lucide="snowflake" class="w-10 h-10 animate-[spin_3s_linear_infinite]"></i>
                </button>
                <span class="text-xs font-bold opacity-70 animate-pulse">Ú©ÛŒ Ø¨Ø±Ù Ù…ÛŒØ§Ø¯ØŸ</span>
            </div>

            <!-- Inline Result Area (No Popups) -->
            <div id="prediction-result" class="w-full max-w-md hidden fade-in mt-4">
                <!-- Result injected here -->
            </div>
        </div>

        <!-- Date Selector Container -->
        <div id="date-selector-container" class="w-full max-w-4xl mx-auto mb-8 hidden fade-in">
            <div class="glass-card p-2 rounded-2xl overflow-x-auto hide-scroll flex gap-2 justify-start md:justify-center" id="date-selector-list">
                <!-- Dates injected here -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden flex-col items-center justify-center py-20 opacity-50">
            <i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-4"></i>
            <p class="text-sm animate-pulse">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡...</p>
        </div>

        <!-- Content Container -->
        <div id="content-area" class="space-y-12">
            <!-- Dynamic Content Injected Here -->
        </div>

    </main>

    <!-- Info Section (Sources) -->
    <section class="w-full max-w-6xl mx-auto px-6 py-8 border-t border-current/10 mt-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-xs opacity-70 leading-relaxed">
            <div>
                <h4 class="font-bold text-sm mb-2 opacity-100 flex items-center gap-2"><i data-lucide="info" class="w-3 h-3"></i> ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ³Øª Ùˆ ØªÙ„Ù‡â€ŒÚ©Ø§Ø¨ÛŒÙ†</h4>
                <p>Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹ Ø§Ø² Ø¨Ø§Ø² Ø¨ÙˆØ¯Ù† Ù¾ÛŒØ³Øªâ€ŒÙ‡Ø§ØŒ Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ù†Ø¨Ø¹ <strong>Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ø³Ù…ÛŒ</strong> Ù‡Ø± Ù¾ÛŒØ³Øª ÛŒØ§ ØªÙ…Ø§Ø³ ØªÙ„ÙÙ†ÛŒ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒ Ø§Ø³Øª. Ø§ÛŒÙ† Ø³Ø§ÛŒØª ÙÙ‚Ø· Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.</p>
            </div>
            <div>
                <h4 class="font-bold text-sm mb-2 opacity-100 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-3 h-3"></i> Ù‡Ø´Ø¯Ø§Ø± Ø§ÛŒÙ…Ù†ÛŒ</h4>
                <p>Ø¯Ø± Ø¨Ø§Ø¯Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ Û³Û° Ú©ÛŒÙ„ÙˆÙ…ØªØ±/Ø³Ø§Ø¹Øª Ùˆ Ø¯ÛŒØ¯ Ú©Ù…ØŒ Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ØªÙ„Ù‡â€ŒÚ©Ø§Ø¨ÛŒÙ† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯. Ù‡Ù…ÛŒØ´Ù‡ Ù¾ÛŒØ´ Ø§Ø² Ø­Ø±Ú©ØªØŒ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÙ‡Ø³ØªØ§Ù†ÛŒ (Ú†Ø§Ù„ÙˆØ³/Ø´Ù…Ø´Ú©) Ø±Ø§ Ø§Ø² Ù¾Ù„ÛŒØ³ Ø±Ø§Ù‡ (Û±Û´Û±) Ú†Ú© Ú©Ù†ÛŒØ¯.</p>
            </div>
            <div>
                <h4 class="font-bold text-sm mb-2 opacity-100 flex items-center gap-2"><i data-lucide="database" class="w-3 h-3"></i> Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ: Open-Meteo (ECMWF High Res)</li>
                    <li>ØªØ­Ù„ÛŒÙ„ Ø¨Ø±Ù: Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù‡ÙˆØ§Ø±Ù‡â€ŒØ§ÛŒ</li>
                    <li>ØªÙˆØ³Ø¹Ù‡: Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ù…Ø¹Ù‡ Ø§Ø³Ú©ÛŒ Ø§ÛŒØ±Ø§Ù†</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="w-full py-6 px-6 text-center text-xs opacity-50 border-t border-current/5 mt-auto">
        <div class="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <p>Â© Û±Û´Û°Û³ - Ú©ÛŒ Ø¨Ø±Ù Ù…ÛŒØ§Ø¯ØŸ</p>
            <a href="https://github.com/emadewij-collab/snowf" target="_blank" class="flex items-center gap-2 hover:opacity-100 transition-opacity">
                <i data-lucide="github" class="w-3 h-3"></i>
                <span>emadewij-collab/snowf</span>
            </a>
        </div>
    </footer>

    <!-- Application Logic -->
    <script>
        // --- Configuration & Data ---
        
        const RESORTS = {
            tochal: {
                id: 'tochal',
                name: 'Ù¾ÛŒØ³Øª Ø§Ø³Ú©ÛŒ Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„ÛŒ ØªÙˆÚ†Ø§Ù„',
                locations: [
                    { name: 'Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Û· (Ù‚Ù„Ù‡)', alt: '3740m', lat: 35.8853, lon: 51.4150 },
                    { name: 'Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Ûµ (Ø¯Ø§Ù…Ù†Ù‡)', alt: '2935m', lat: 35.8600, lon: 51.4080 },
                    { name: 'Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Û± (Ù¾Ø§ÛŒ Ú©ÙˆÙ‡)', alt: '1900m', lat: 35.8195, lon: 51.4100 }
                ]
            },
            dizin: {
                id: 'dizin',
                name: 'Ù¾ÛŒØ³Øª Ø§Ø³Ú©ÛŒ Ø¯ÛŒØ²ÛŒÙ†',
                locations: [
                    { name: 'Ù‚Ù„Ù‡ (Ø³ÛŒâ€ŒÚ†Ø§Ù„)', alt: '3600m', lat: 36.0540, lon: 51.4180 },
                    { name: 'Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯ Ø¨Ø§Ù„Ø§', alt: '3000m', lat: 36.0460, lon: 51.4150 },
                    { name: 'Ù‡ØªÙ„ (Ù¾Ø§ÛŒÛŒÙ†)', alt: '2650m', lat: 36.0350, lon: 51.4100 }
                ]
            },
            darbandsar: {
                id: 'darbandsar',
                name: 'Ù¾ÛŒØ³Øª Ø§Ø³Ú©ÛŒ Ø¯Ø±Ø¨Ù†Ø¯Ø³Ø±',
                locations: [
                    { name: 'Ù‚Ù„Ù‡', alt: '3570m', lat: 36.0180, lon: 51.4650 },
                    { name: 'Ù…ÛŒØ§Ù†â€ŒØ±Ø§Ù‡', alt: '3000m', lat: 36.0150, lon: 51.4600 },
                    { name: 'Ù¾Ø§ÛŒÛŒÙ†', alt: '2600m', lat: 36.0100, lon: 51.4550 }
                ]
            }
        };

        const weatherStore = {};
        let currentSelection = 'tochal'; // Default Resort
        let selectedDayIndex = 0; // Default Date (0 = Today)

        // WMO Weather Codes
        function getWeatherStatus(code) {
            const map = {
                0: { text: 'Ø¢Ø³Ù…Ø§Ù† ØµØ§Ù', icon: 'sun' },
                1: { text: 'Ú©Ù…ÛŒ Ø§Ø¨Ø±ÛŒ', icon: 'cloud-sun' },
                2: { text: 'Ù†ÛŒÙ…Ù‡ Ø§Ø¨Ø±ÛŒ', icon: 'cloud' },
                3: { text: 'Ø§Ø¨Ø±ÛŒ', icon: 'cloud' },
                45: { text: 'Ù…Ù‡â€ŒØ¢Ù„ÙˆØ¯', icon: 'cloud-fog' },
                48: { text: 'Ù…Ù‡ ÛŒØ®â€ŒØ²Ø¯Ù‡', icon: 'cloud-fog' },
                51: { text: 'Ù†Ù…â€ŒÙ†Ù… Ø¨Ø§Ø±Ø§Ù†', icon: 'cloud-drizzle' },
                53: { text: 'Ø¨Ø§Ø±Ø§Ù† Ù…Ù„Ø§ÛŒÙ…', icon: 'cloud-rain' },
                55: { text: 'Ø¨Ø§Ø±Ø§Ù† Ø´Ø¯ÛŒØ¯', icon: 'cloud-rain' },
                61: { text: 'Ø¨Ø§Ø±Ø§Ù†', icon: 'cloud-rain' },
                63: { text: 'Ø¨Ø§Ø±Ø§Ù†', icon: 'cloud-rain' },
                65: { text: 'Ø¨Ø§Ø±Ø§Ù† Ø³ÛŒÙ„â€ŒØ¢Ø³Ø§', icon: 'cloud-rain-wind' },
                71: { text: 'Ø¨Ø±Ù Ø³Ø¨Ú©', icon: 'snowflake' },
                73: { text: 'Ø¨Ø±Ù Ù…ØªÙˆØ³Ø·', icon: 'snowflake' },
                75: { text: 'Ø¨Ø±Ù Ø³Ù†Ú¯ÛŒÙ†', icon: 'snowflake' },
                77: { text: 'Ø¯Ø§Ù†Ù‡ Ø¨Ø±Ù', icon: 'snowflake' },
                80: { text: 'Ø±Ú¯Ø¨Ø§Ø±', icon: 'cloud-rain' },
                81: { text: 'Ø±Ú¯Ø¨Ø§Ø± Ø´Ø¯ÛŒØ¯', icon: 'cloud-rain' },
                82: { text: 'Ø±Ú¯Ø¨Ø§Ø± Ø³ÛŒÙ„â€ŒØ¢Ø³Ø§', icon: 'cloud-rain' },
                85: { text: 'Ø±Ú¯Ø¨Ø§Ø± Ø¨Ø±Ù', icon: 'snowflake' },
                86: { text: 'Ú©ÙˆÙ„Ø§Ú© Ø¨Ø±Ù', icon: 'snowflake' }
            };
            return map[code] || { text: 'Ù†Ø§Ù…Ø´Ø®Øµ', icon: 'help-circle' };
        }

        // Wind Guide Logic (Updated)
        function getWindStatus(speed) {
            if (speed <= 10) return { label: 'Ø®ÛŒÙ„ÛŒ Ø±Ø§Ø­Øª', icon: 'check', desc: 'Ø¨Ø§Ø¯ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ Ù‡ÛŒÚ† ØªØ£Ø«ÛŒØ±ÛŒ Ù†Ø¯Ø§Ø±Ø¯Ø› Ú©Ù†ØªØ±Ù„ Ú©Ø§Ù…Ù„ Ø¯Ø§Ø±ÛŒØ¯.', color: 'text-green-600', bg: 'bg-green-500/10' };
            if (speed <= 20) return { label: 'Ø±Ø§Ø­Øª', icon: 'smile', desc: 'Ú©Ù…ÛŒ Ø§Ø­Ø³Ø§Ø³ Ø¨Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯Ø› ØªØ£Ø«ÛŒØ± Ú©Ù… Ø±ÙˆÛŒ ØªØ¹Ø§Ø¯Ù„.', color: 'text-emerald-600', bg: 'bg-emerald-500/10' };
            if (speed <= 30) return { label: 'Ú†Ø§Ù„Ø´â€ŒØ¯Ø§Ø±', icon: 'alert-triangle', desc: 'Ø¨Ø§Ø¯ Ù‚Ø§Ø¨Ù„ ØªÙˆØ¬Ù‡Ø› Ú©Ù†ØªØ±Ù„ Ø³Ø±Ø¹Øª Ø³Ø®Øªâ€ŒØªØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯.', color: 'text-yellow-600', bg: 'bg-yellow-500/10' };
            if (speed <= 40) return { label: 'Ø³Ø®Øª', icon: 'zap', desc: 'Ø¨Ø§Ø¯ Ø´Ø¯ÛŒØ¯Ø› ØªØ¹Ø§Ø¯Ù„ Ø³Ø®ØªØŒ Ø§Ø­ØªÙ…Ø§Ù„ Ø­Ø±Ú©Øª Ø¬Ø§Ù†Ø¨ÛŒ.', color: 'text-orange-600', bg: 'bg-orange-500/10' };
            if (speed <= 50) return { label: 'Ø®Ø·Ø±Ù†Ø§Ú©', icon: 'x', desc: 'ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ú©Ù†ØªØ±Ù„Ø› Ø§Ø­ØªÙ…Ø§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ù¾ÛŒØ³Øª.', color: 'text-red-600', bg: 'bg-red-500/10' };
            return { label: 'Ù…Ù…Ù†ÙˆØ¹', icon: 'ban', desc: 'Ø®ÛŒÙ„ÛŒ Ø®Ø·Ø±Ù†Ø§Ú©Ø› ÙÙ‚Ø· Ø­Ø±ÙÙ‡â€ŒØ§ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø®Ø§Øµ.', color: 'text-red-800', bg: 'bg-red-900/10' };
        }

        // Goggles Recommendation Logic (Updated based on new table)
        function getGoggleInfo(weatherCode, isDay) {
            // Condition 1: Low / Cloudy (Dense Clouds)
            // Includes: Night, Overcast (3), Fog (45,48), Rain/Snow (51+)
            if (isDay === 0 || weatherCode >= 3) {
                return {
                    condition: 'Ú©Ù… / Ø§Ø¨Ø±ÛŒ',
                    effect: 'Ø±Ø§Ø­Øª / Ø¯ÛŒØ¯ Ø®ÙˆØ¨ ğŸ™‚',
                    tips: 'Ø¹ÛŒÙ†Ú© Ø§Ø³Ú©ÛŒ Ø¨Ø§ Ø´ÛŒØ´Ù‡ Ø±ÙˆØ´Ù†Ø› Ø§Ù†Ø¹Ú©Ø§Ø³ Ù†ÙˆØ± Ú©Ù…ØŒ Ø¯ÛŒØ¯ ÙˆØ§Ø¶Ø­ Ø§Ø³Øª.',
                    vlt: '60â€“90%',
                    bg: 'bg-gray-500/10',
                    textColor: 'text-gray-600',
                    icon: isDay === 0 ? 'moon' : 'cloud'
                };
            }

            // Condition 2: Medium / Scattered Sun
            // Includes: Partly Cloudy (2)
            if (weatherCode === 2) {
                return {
                    condition: 'Ù…ØªÙˆØ³Ø· / Ø¢ÙØªØ§Ø¨ Ù¾Ø±Ø§Ú©Ù†Ø¯Ù‡',
                    effect: 'Ù…ØªÙˆØ³Ø· â€“ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡ âš ï¸',
                    tips: 'Ø¹ÛŒÙ†Ú© Ø¨Ø§ Ø´ÛŒØ´Ù‡ Ù†ÛŒÙ…Ù‡ ØªÛŒØ±Ù‡ (Category 2) Ù…Ù†Ø§Ø³Ø¨Ø› Ú©Ù…ÛŒ Ø§Ù†Ø¹Ú©Ø§Ø³ Ø±ÙˆÛŒ Ø¨Ø±Ù Ø§Ø³Øª.',
                    vlt: '30â€“60%',
                    bg: 'bg-yellow-500/10',
                    textColor: 'text-yellow-700',
                    icon: 'cloud-sun'
                };
            }

            // Condition 3: High / Bright Sun
            // Includes: Mainly Clear (1)
            if (weatherCode === 1) {
                return {
                    condition: 'Ø²ÛŒØ§Ø¯ / Ø¢ÙØªØ§Ø¨ Ø±ÙˆØ´Ù†',
                    effect: 'Ú†Ø§Ù„Ø´â€ŒØ¯Ø§Ø± âš¡',
                    fullEffect: 'Ú†Ø§Ù„Ø´â€ŒØ¯Ø§Ø± / Ø§Ø­ØªÙ…Ø§Ù„ Ø®Ø³ØªÚ¯ÛŒ Ú†Ø´Ù… âš¡',
                    tips: 'Ø¹ÛŒÙ†Ú© ØªÛŒØ±Ù‡ (Category 3) Ø¨Ø§ ÙÛŒÙ„ØªØ± UVØ› Ø¶Ø¯ Ø¨Ø®Ø§Ø± Ùˆ ÙÛŒØª Ù…Ù†Ø§Ø³Ø¨.',
                    vlt: '10â€“30%',
                    bg: 'bg-orange-500/10',
                    textColor: 'text-orange-700',
                    icon: 'sun'
                };
            }

            // Condition 4: Very High / Shiny Snow
            // Includes: Clear Sky (0)
            if (weatherCode === 0) {
                return {
                    condition: 'Ø®ÛŒÙ„ÛŒ Ø²ÛŒØ§Ø¯ / Ø¨Ø±Ù Ø¨Ø±Ø§Ù‚',
                    effect: 'Ø®Ø·Ø±Ù†Ø§Ú© / Ø®ÛŒØ±Ú¯ÛŒ Ø´Ø¯ÛŒØ¯ âŒ',
                    fullEffect: 'Ø®Ø·Ø±Ù†Ø§Ú© / Ø®ÛŒØ±Ú¯ÛŒ Ø´Ø¯ÛŒØ¯ âŒ',
                    tips: 'Ø¹ÛŒÙ†Ú© Ø¨Ø³ÛŒØ§Ø± ØªÛŒØ±Ù‡ ÛŒØ§ Ø¢ÛŒÙ†Ù‡â€ŒØ§ÛŒ (mirror) Ø¨Ø§ ÙÛŒÙ„ØªØ± UVØ› ØªÙˆÙ‚Ù Ø¯Ø± ØµÙˆØ±Øª Ø®Ø³ØªÚ¯ÛŒ Ú†Ø´Ù….',
                    vlt: '5â€“10%',
                    bg: 'bg-red-500/10',
                    textColor: 'text-red-700',
                    icon: 'glasses'
                };
            }

            // Fallback
            return {
                condition: 'Ù†Ø§Ù…Ø´Ø®Øµ',
                effect: 'Ù…Ø¹Ù…ÙˆÙ„ÛŒ',
                tips: 'Ø¹ÛŒÙ†Ú© Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø§ Ù…Ø­Ø§ÙØ¸ UV Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.',
                vlt: '---',
                bg: 'bg-gray-200',
                textColor: 'text-gray-500',
                icon: 'help-circle'
            };
        }

        // --- Logic Functions ---

        function setTheme(themeName) {
            document.body.className = `${themeName} min-h-screen flex flex-col`;
        }

        function getPersianWeekday(dateObj) {
            const days = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];
            return days[dateObj.getDay()];
        }

        function getPersianDateString(offset = 0) {
            const d = new Date();
            d.setDate(d.getDate() + offset);
            const options = { month: 'long', day: 'numeric' };
            // Using a simple mock if Intl not fully supported or just simple formatting
            // But let's try to get day number and month map for lightweight solution
            const day = d.getDate();
            // Note: Native JS Intl might produce 'Û±Û´ Ù†ÙˆØ§Ù…Ø¨Ø±', we want 'Û²Û´ Ø¢Ø¨Ø§Ù†'.
            // For this demo, I will stick to simple Weekday Name as primary, and just show date number if possible.
            // Or better: Use Intl with 'fa-IR'
            return {
                weekday: getPersianWeekday(d),
                fullDate: new Intl.DateTimeFormat('fa-IR', { day: 'numeric', month: 'long' }).format(d),
                iso: d.toISOString().split('T')[0]
            };
        }

        async function fetchWeatherData(lat, lon) {
            // Added hourly for breakdown with more details for modal
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,is_day,precipitation,rain,snowfall,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,snowfall_sum,precipitation_probability_max&hourly=temperature_2m,weather_code,wind_speed_10m,is_day,relative_humidity_2m,cloud_cover,precipitation,snowfall,wind_direction_10m&forecast_days=16&timezone=Asia%2FTehran`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error("Error fetching weather:", error);
                return null;
            }
        }

        function renderDateSelector() {
            const container = document.getElementById('date-selector-list');
            container.innerHTML = '';
            
            for(let i=0; i<7; i++) { // Show 7 days
                const dateInfo = getPersianDateString(i);
                const isSelected = i === selectedDayIndex;
                
                const btn = document.createElement('button');
                btn.onclick = () => selectDate(i);
                btn.className = `flex flex-col items-center justify-center px-4 py-2 rounded-xl min-w-[80px] transition-all ${isSelected ? 'accent-bg text-white shadow-md scale-105' : 'bg-transparent opacity-60 hover:opacity-100 hover:bg-white/10'}`;
                btn.innerHTML = `
                    <span class="text-sm font-bold mb-1">${i === 0 ? 'Ø§Ù…Ø±ÙˆØ²' : dateInfo.weekday}</span>
                    <span class="text-xs font-mono opacity-80">${dateInfo.fullDate}</span>
                `;
                container.appendChild(btn);
            }
            document.getElementById('date-selector-container').classList.remove('hidden');
        }

        function selectDate(index) {
            selectedDayIndex = index;
            renderDateSelector(); // Update active state
            // Re-render cards with new date (using cached data)
            renderResortCards(currentSelection);
        }

        function createCardHTML(locationName, alt, data, dayIndex, resortKey, locIndex) {
            if (!data) return `<div class="glass-card p-6 rounded-2xl text-center">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>`;

            const daily = data.daily;
            const hourly = data.hourly;
            
            // Determine "Main" temp to show
            // If Today (dayIndex 0): Show Current Temp
            // If Future: Show Max Temp
            let mainTemp, mainLabel;
            if (dayIndex === 0) {
                mainTemp = Math.round(data.current.temperature_2m);
                mainLabel = 'Ø¯Ù…Ø§ÛŒ ÙØ¹Ù„ÛŒ';
            } else {
                mainTemp = Math.round(daily.temperature_2m_max[dayIndex]);
                mainLabel = 'Ø¯Ù…Ø§ÛŒ Ø¨ÛŒØ´ÛŒÙ†Ù‡';
            }
            
            const weatherCode = daily.weather_code[dayIndex];
            const weather = getWeatherStatus(weatherCode);
            
            // Hourly Breakdown for specific Day
            // Hours: 9, 12, 15, 20
            const targetHours = [9, 12, 15, 20];
            const timeLabels = ['ØµØ¨Ø­ (Û¹)', 'Ø¸Ù‡Ø± (Û±Û²)', 'Ø¹ØµØ± (Û±Ûµ)', 'Ø´Ø¨ (Û²Û°)'];
            
            let gridHTML = '';
            
            targetHours.forEach((hour, idx) => {
                const hourlyIndex = (dayIndex * 24) + hour;
                
                // Check if index exists
                if (hourlyIndex >= hourly.time.length) return;

                const tTemp = Math.round(hourly.temperature_2m[hourlyIndex]);
                const tWind = Math.round(hourly.wind_speed_10m[hourlyIndex]);
                const tCode = hourly.weather_code[hourlyIndex];
                const tIsDay = hourly.is_day[hourlyIndex];
                
                const tGoggle = getGoggleInfo(tCode, tIsDay);
                const tWindStatus = getWindStatus(tWind);
                
                // Build column
                gridHTML += `
                    <button onclick="openHourlyDetails('${resortKey}', ${locIndex}, ${hourlyIndex}, '${timeLabels[idx]}')" class="flex flex-col gap-2 items-center p-2 bg-white/40 rounded-xl border border-current/5 min-h-[160px] shadow-sm hover:bg-white/60 hover:scale-105 transition-all cursor-pointer text-center">
                        <span class="text-xs font-bold opacity-60 border-b border-current/10 pb-1 w-full text-center">${timeLabels[idx]}</span>
                        
                        <!-- Temp -->
                        <div class="flex items-center justify-center w-full my-1">
                             <span class="text-xl font-black dir-ltr ${tTemp < 0 ? 'text-blue-600' : 'text-orange-600'}">${tTemp}Â°</span>
                        </div>

                        <!-- Wind -->
                        <div class="flex flex-col items-center w-full bg-white/60 rounded p-1.5 mb-1 shadow-inner">
                            <div class="flex items-center gap-1">
                                <span class="text-xs font-bold dir-ltr ${tWindStatus.color}">${tWind}</span>
                                <span class="text-[10px] opacity-60">km</span>
                            </div>
                            <span class="text-[9px] font-bold ${tWindStatus.color} text-center leading-tight">${tWindStatus.label}</span>
                        </div>

                        <!-- Goggle -->
                         <div class="flex flex-col items-center w-full mt-auto pt-1 border-t border-current/5">
                            <i data-lucide="${tGoggle.icon}" class="w-4 h-4 mb-1 ${tGoggle.textColor}"></i>
                            <span class="text-[9px] font-bold text-center leading-tight opacity-90 truncate w-full px-1">${tGoggle.condition}</span>
                            <span class="text-[9px] opacity-60 dir-ltr font-mono">${tGoggle.vlt}</span>
                        </div>
                    </button>
                `;
            });

            const dateInfo = getPersianDateString(dayIndex);

            return `
                <div class="glass-card p-5 rounded-3xl flex flex-col gap-4 fade-in relative overflow-hidden">
                    
                    <!-- Header -->
                    <div class="flex justify-between items-start border-b border-current/10 pb-3">
                        <div>
                            <h3 class="font-bold text-xl">${locationName}</h3>
                            <span class="text-xs font-mono opacity-60 bg-current/5 px-2 py-0.5 rounded">${alt}</span>
                        </div>
                        <div class="flex flex-col items-end">
                             <span class="text-[10px] font-bold opacity-50 mb-1">${dateInfo.weekday}</span>
                            <div class="flex items-center gap-1.5">
                                <span class="text-xs font-bold opacity-80">${weather.text}</span>
                                <i data-lucide="${weather.icon}" class="w-6 h-6 accent-text"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Main Temps -->
                    <div class="flex items-end justify-between px-4 py-2">
                        <!-- Min -->
                        <div class="flex flex-col items-center text-blue-500">
                            <span class="text-[10px] opacity-70 mb-1">Ú©Ù…ÛŒÙ†Ù‡</span>
                            <span class="text-xl font-bold dir-ltr">${Math.round(daily.temperature_2m_min[dayIndex])}Â°</span>
                        </div>

                        <!-- Main -->
                        <div class="flex flex-col items-center pb-1 px-4">
                            <span class="text-5xl font-black tracking-tighter dir-ltr">${mainTemp}Â°</span>
                            <span class="text-[10px] opacity-60 mt-1">${mainLabel}</span>
                        </div>

                        <!-- Max -->
                        <div class="flex flex-col items-center text-red-500">
                            <span class="text-[10px] opacity-70 mb-1">Ø¨ÛŒØ´ÛŒÙ†Ù‡</span>
                            <span class="text-xl font-bold dir-ltr">${Math.round(daily.temperature_2m_max[dayIndex])}Â°</span>
                        </div>
                    </div>

                    <!-- Hourly Grid Header -->
                    <div class="grid grid-cols-4 gap-2 mt-2">
                        ${gridHTML}
                    </div>

                    <!-- Footer Stats -->
                    <div class="flex justify-between items-center text-[10px] opacity-70 pt-3 border-t border-current/10">
                         <div class="flex items-center gap-1">
                            <i data-lucide="cloud-rain" class="w-3 h-3"></i>
                            <span>Ø¨Ø§Ø±Ø´: <span class="dir-ltr font-bold">${daily.snowfall_sum[dayIndex]} cm</span></span>
                        </div>
                        <div class="flex items-center gap-1">
                             <i data-lucide="droplets" class="w-3 h-3"></i>
                            <span>Ø§Ø­ØªÙ…Ø§Ù„: <span class="dir-ltr font-bold">${daily.precipitation_probability_max[dayIndex]}%</span></span>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderResortCards(resortKey) {
            const container = document.getElementById(`cards-${resortKey}`);
            // If container doesn't exist (first load), renderResort handles it. 
            // But for date switching, we need to clear and rebuild only cards.
            // Helper for createCardHTML usage
            
            const resort = RESORTS[resortKey];
            if(!weatherStore[resortKey]) return; // Should be loaded

            container.innerHTML = '';
            
            weatherStore[resortKey].forEach((data, index) => {
                const loc = resort.locations[index];
                container.innerHTML += createCardHTML(loc.name, loc.alt, data, selectedDayIndex, resortKey, index);
            });
            lucide.createIcons();
        }

        function openHourlyDetails(resortKey, locIndex, hourlyIndex, timeLabel) {
            const data = weatherStore[resortKey][locIndex];
            const h = data.hourly;
            
            const temp = Math.round(h.temperature_2m[hourlyIndex]);
            const wind = Math.round(h.wind_speed_10m[hourlyIndex]);
            const windDir = h.wind_direction_10m[hourlyIndex];
            const humidity = h.relative_humidity_2m[hourlyIndex];
            const cloud = h.cloud_cover[hourlyIndex];
            const snow = h.snowfall[hourlyIndex];
            const precip = h.precipitation[hourlyIndex];
            const code = h.weather_code[hourlyIndex];
            const isDay = h.is_day[hourlyIndex];

            const weather = getWeatherStatus(code);
            const windStatus = getWindStatus(wind);
            const goggle = getGoggleInfo(code, isDay);
            const locationName = RESORTS[resortKey].locations[locIndex].name;
            const resortName = RESORTS[resortKey].name;

            const modal = document.getElementById('hourly-modal');
            const content = document.getElementById('modal-content');

            content.innerHTML = `
                <div class="text-center border-b border-current/10 pb-4">
                    <h3 class="text-xl font-black">${resortName} - ${locationName}</h3>
                    <div class="inline-block bg-current/5 px-3 py-1 rounded-full mt-2">
                        <span class="text-sm font-bold opacity-80">ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ø¹Øª ${timeLabel}</span>
                    </div>
                </div>

                <!-- Main Stats -->
                <div class="flex justify-center items-center gap-6">
                     <div class="flex flex-col items-center">
                        <i data-lucide="${weather.icon}" class="w-12 h-12 accent-text mb-2"></i>
                        <span class="font-bold opacity-80">${weather.text}</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-5xl font-black dir-ltr ${temp < 0 ? 'text-blue-600' : 'text-orange-600'}">${temp}Â°</span>
                        <span class="text-xs opacity-60 mt-1">Ø¯Ù…Ø§</span>
                    </div>
                </div>

                <!-- Grid Details -->
                <div class="grid grid-cols-2 gap-4">
                    <!-- Wind Section -->
                    <div class="col-span-2 glass-card bg-white/40 p-4 rounded-xl border border-current/10">
                        <div class="flex items-center gap-2 mb-2 opacity-80">
                            <i data-lucide="wind" class="w-4 h-4"></i>
                            <span class="font-bold text-sm">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø¯</span>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-2xl font-black dir-ltr ${windStatus.color}">${wind} <span class="text-sm opacity-50">km/h</span></span>
                            <span class="font-bold text-sm ${windStatus.color}">${windStatus.label}</span>
                        </div>
                        <p class="text-xs opacity-70 leading-relaxed bg-white/50 p-2 rounded-lg">
                            ${windStatus.desc}
                        </p>
                    </div>

                    <!-- Goggle Section -->
                    <div class="col-span-2 glass-card bg-white/40 p-4 rounded-xl border border-current/10">
                         <div class="flex items-center gap-2 mb-2 opacity-80">
                            <i data-lucide="${goggle.icon}" class="w-4 h-4"></i>
                            <span class="font-bold text-sm">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¹ÛŒÙ†Ú©</span>
                        </div>
                         <div class="flex items-center justify-between mb-2">
                            <span class="font-bold text-sm">${goggle.condition}</span>
                             <span class="text-xs font-mono dir-ltr bg-black/5 px-2 py-1 rounded">VLT: ${goggle.vlt}</span>
                        </div>
                        <div class="flex flex-col gap-2 text-xs opacity-80 bg-white/50 p-3 rounded-lg">
                             <div class="flex justify-between items-center border-b border-black/5 pb-2">
                                <span class="font-bold opacity-70">ØªØ£Ø«ÛŒØ±:</span>
                                <span class="font-bold ${goggle.textColor}">${goggle.fullEffect || goggle.effect}</span>
                             </div>
                             <div class="mt-1">
                                <p class="leading-relaxed">${goggle.tips}</p>
                             </div>
                        </div>
                    </div>

                    <!-- Extra Stats -->
                    <div class="bg-white/30 p-3 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-xs opacity-60">Ø±Ø·ÙˆØ¨Øª</span>
                        <span class="font-bold dir-ltr">${humidity}%</span>
                    </div>
                    <div class="bg-white/30 p-3 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-xs opacity-60">Ù¾ÙˆØ´Ø´ Ø§Ø¨Ø±</span>
                        <span class="font-bold dir-ltr">${cloud}%</span>
                    </div>
                    <div class="bg-white/30 p-3 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-xs opacity-60">Ø¨Ø§Ø±Ø´ Ø¨Ø±Ù</span>
                        <span class="font-bold dir-ltr text-blue-600">${snow} cm</span>
                    </div>
                    <div class="bg-white/30 p-3 rounded-xl flex flex-col items-center gap-1">
                        <span class="text-xs opacity-60">Ø¬Ù‡Øª Ø¨Ø§Ø¯</span>
                        <span class="font-bold dir-ltr" style="transform: rotate(${windDir}deg); display:inline-block">â†‘</span>
                        <span class="text-[10px] opacity-50 dir-ltr">${windDir}Â°</span>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function closeModal(event) {
            if (event && event.target.id !== 'hourly-modal' && !event.target.closest('button')) return;
            const modal = document.getElementById('hourly-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function renderResort(resortKey) {
            const container = document.getElementById('content-area');
            const resort = RESORTS[resortKey];
            
            // Main Structure
            const section = document.createElement('section');
            section.className = 'mb-12 animate-float-up';
            section.innerHTML = `
                <div class="flex items-center gap-2 mb-6 px-2">
                    <div class="w-1 h-6 accent-bg rounded-full"></div>
                    <h2 class="text-2xl font-bold tracking-tight">${resort.name}</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="cards-${resortKey}"></div>
            `;
            container.innerHTML = ''; // Clear previous
            container.appendChild(section);

            // Render Dates
            renderDateSelector();

            const cardsContainer = document.getElementById(`cards-${resortKey}`);
            
            if (!weatherStore[resortKey]) weatherStore[resortKey] = [];

            const promises = resort.locations.map(loc => fetchWeatherData(loc.lat, loc.lon));
            const results = await Promise.all(promises);

            results.forEach((data, index) => {
                weatherStore[resortKey][index] = data;
            });
            
            renderResortCards(resortKey);
        }

        async function loadResort(selection) {
            currentSelection = selection;
            selectedDayIndex = 0; // Reset date on resort switch
            
            const loading = document.getElementById('loading');
            const resultArea = document.getElementById('prediction-result');
            const buttons = document.querySelectorAll('.resort-btn');

            // Reset UI
            resultArea.innerHTML = ''; 
            resultArea.classList.add('hidden');
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            
            // Button Styles
            buttons.forEach(btn => {
                btn.classList.remove('accent-bg', 'text-white', 'opacity-100', 'shadow-lg');
                btn.classList.add('bg-transparent', 'opacity-60');
            });
            const activeBtn = document.getElementById(`btn-${selection}`);
            if(activeBtn) {
                activeBtn.classList.add('accent-bg', 'text-white', 'opacity-100', 'shadow-lg');
                activeBtn.classList.remove('bg-transparent', 'opacity-60');
            }

            await renderResort(selection);

            loading.classList.add('hidden');
            loading.classList.remove('flex');
        }

        // --- Magic Button Logic (Inline) ---

        function askWhenSnow() {
            const resultDiv = document.getElementById('prediction-result');
            resultDiv.innerHTML = `<div class="flex justify-center p-4"><i data-lucide="loader" class="animate-spin"></i></div>`;
            resultDiv.classList.remove('hidden');
            lucide.createIcons();

            // Simulate tiny delay for "Calculating" feel
            setTimeout(() => {
                let bestSnowEvent = null;
                
                // Only check the CURRENTLY selected resort
                const rKey = currentSelection;
                const resortData = weatherStore[rKey];
                
                if (!resortData) return;

                resortData.forEach((data, locIndex) => {
                    if (!data || !data.daily) return;
                    const locName = RESORTS[rKey].locations[locIndex].name;
                    const resortName = RESORTS[rKey].name;

                    const daysCount = data.daily.time.length;
                    for (let i = 0; i < daysCount; i++) {
                        const snowAmount = data.daily.snowfall_sum[i];
                        if (snowAmount > 0) {
                            // Priority: Sooner day > More snow
                            if (!bestSnowEvent || 
                                i < bestSnowEvent.dayIndex || 
                                (i === bestSnowEvent.dayIndex && snowAmount > bestSnowEvent.amount)) {
                                
                                bestSnowEvent = {
                                    dayIndex: i,
                                    amount: snowAmount,
                                    prob: data.daily.precipitation_probability_max[i],
                                    resort: resortName,
                                    location: locName,
                                    tempMax: data.daily.temperature_2m_max[i],
                                    tempMin: data.daily.temperature_2m_min[i]
                                };
                            }
                        }
                    }
                });

                if (bestSnowEvent) {
                    let dayName;
                    if (bestSnowEvent.dayIndex === 0) dayName = 'Ù‡Ù…ÛŒÙ† Ø§Ù…Ø±ÙˆØ²';
                    else if (bestSnowEvent.dayIndex === 1) dayName = 'ÙØ±Ø¯Ø§';
                    else if (bestSnowEvent.dayIndex === 2) dayName = 'Ù¾Ø³â€ŒÙØ±Ø¯Ø§';
                    else dayName = `${bestSnowEvent.dayIndex} Ø±ÙˆØ² Ø¯ÛŒÚ¯Ù‡`;

                    // Simplified Result: No specific station, no temp, just resort + day + snow amount
                    resultDiv.innerHTML = `
                        <div class="glass-card p-6 rounded-2xl border-2 border-blue-400/30 bg-blue-50/50 mt-4 relative overflow-hidden text-center">
                            <div class="absolute -left-4 -top-4 w-32 h-32 bg-blue-400/20 rounded-full blur-xl"></div>
                            <div class="relative z-10 flex flex-col items-center gap-3">
                                <h4 class="text-2xl font-black text-blue-900">Ù¾ÛŒØ¯Ø§ Ø´Ø¯: ${dayName}!</h4>
                                <div class="flex flex-col items-center gap-1">
                                    <p class="text-sm opacity-80">
                                        Ø¯Ø± <strong>${bestSnowEvent.resort}</strong>
                                    </p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <i data-lucide="snowflake" class="w-6 h-6 text-blue-500 animate-bounce"></i>
                                        <span class="font-black text-3xl text-blue-700 dir-ltr">${bestSnowEvent.amount} cm</span>
                                        <span class="text-sm font-bold opacity-60">Ø¨Ø±Ù ØªØ§Ø²Ù‡</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="glass-card p-4 rounded-xl border border-orange-200 bg-orange-50/50 mt-4 text-center">
                            <p class="text-sm text-orange-800 font-bold">ÙØ¹Ù„Ø§Ù‹ Ø®Ø¨Ø±ÛŒ Ù†ÛŒØ³Øª!</p>
                            <p class="text-xs opacity-70 mt-1">ØªØ§ Û±Û¶ Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ø¯Ø± ${RESORTS[currentSelection].name} Ø¨Ø§Ø±Ø´ Ø¨Ø±Ù Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ù†Ø´Ø¯Ù‡.</p>
                        </div>
                    `;
                }
                lucide.createIcons();
            }, 500);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadResort('tochal');
        });

    </script>
</body>
</html>
