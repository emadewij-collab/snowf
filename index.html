<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ùâ€ŒÚ©Ùˆ | Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø³Ú©ÛŒ</title>
    <meta name="description" content="Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ ØªØ®ØµØµÛŒØŒ Ø§ÛŒÙ…Ù†ÛŒ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ù Ù¾ÛŒØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©ÛŒ Ø§ÛŒØ±Ø§Ù†">
    
    <!-- Version: v2.3 -->
    
    <!-- Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .dir-ltr { direction: ltr; display: inline-block; unicode-bidi: isolate; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Themes */
        .theme-snow {
            --bg-main: #f0f9ff;
            --bg-gradient: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            --bg-card: rgba(255, 255, 255, 0.85);
            --text-primary: #0f172a;
            --accent: #0ea5e9;
            --border: #e0f2fe;
            --card-shadow: 0 10px 30px -10px rgba(14, 165, 233, 0.15);
        }
        .theme-sun {
            --bg-main: #fffbeb;
            --bg-gradient: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            --bg-card: rgba(255, 255, 255, 0.9);
            --text-primary: #451a03;
            --accent: #f59e0b;
            --border: #fef3c7;
            --card-shadow: 0 10px 30px -10px rgba(245, 158, 11, 0.15);
        }
        .theme-night {
            --bg-main: #0f172a;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-card: rgba(30, 41, 59, 0.8);
            --text-primary: #f8fafc;
            --accent: #818cf8;
            --border: #334155;
            --card-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }
        
        body { background: var(--bg-gradient); color: var(--text-primary); min-height: 100vh; }

        .glass-card {
            background-color: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }

        .accent-bg { background-color: var(--accent); }
        .accent-text { color: var(--accent); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin-slow { animation: spin-slow 20s linear infinite; }
        
        /* Snow particles */
        @keyframes snowfall {
            0% { transform: translateY(-10px) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(80px) translateX(10px); opacity: 0; }
        }
        .snow-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: snowfall 3s linear infinite;
        }
        .snow-particle:nth-child(1) { left: 20%; animation-delay: 0s; }
        .snow-particle:nth-child(2) { left: 40%; animation-delay: 0.5s; }
        .snow-particle:nth-child(3) { left: 60%; animation-delay: 1s; }
        .snow-particle:nth-child(4) { left: 80%; animation-delay: 1.5s; }
        .snow-particle:nth-child(5) { left: 30%; animation-delay: 2s; }
        .snow-particle:nth-child(6) { left: 70%; animation-delay: 2.5s; }
    </style>
</head>
<body class="theme-snow flex flex-col">

    <!-- Header -->
    <header class="w-full px-4 py-6 flex flex-col md:flex-row justify-between items-center max-w-7xl mx-auto gap-4">
        <div class="flex items-center gap-4">
            <div class="p-3 rounded-2xl accent-bg text-white shadow-lg">
                <i data-lucide="mountain-snow" class="w-8 h-8"></i>
            </div>
            <div>
                <h1 class="text-3xl font-black">Ø¨Ø±Ùâ€ŒÚ©Ùˆ</h1>
                <p class="text-xs opacity-70 font-bold mt-1">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø³Ú©ÛŒâ€ŒØ¨Ø§Ø²Ø§Ù†</p>
            </div>
        </div>
        
        <!-- Live Clock -->
        <div class="glass-card px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-bold">
            <i data-lucide="clock" class="w-4 h-4 opacity-60"></i>
            <span id="live-clock" class="dir-ltr"></span>
        </div>

        <!-- Theme Switcher -->
        <div class="flex bg-white/20 backdrop-blur-xl rounded-full p-1.5 border border-current/10">
            <button onclick="setTheme('theme-sun')" class="p-2.5 rounded-full hover:bg-white/40 transition-all text-amber-500">
                <i data-lucide="sun" class="w-5 h-5"></i>
            </button>
            <button onclick="setTheme('theme-snow')" class="p-2.5 rounded-full hover:bg-white/40 transition-all text-sky-500">
                <i data-lucide="snowflake" class="w-5 h-5"></i>
            </button>
            <button onclick="setTheme('theme-night')" class="p-2.5 rounded-full hover:bg-white/40 transition-all text-indigo-400">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-4 pb-16 max-w-7xl mx-auto w-full">
        
        <!-- Resort Selector -->
        <div class="flex flex-col items-center my-8 gap-8">
            <div class="glass-card rounded-2xl p-2 flex flex-wrap justify-center gap-1">
                <button onclick="loadResort('tochal')" id="btn-tochal" class="resort-btn px-6 py-3 rounded-xl font-bold text-sm transition-all opacity-70 hover:opacity-100">ØªÙˆÚ†Ø§Ù„</button>
                <button onclick="loadResort('dizin')" id="btn-dizin" class="resort-btn px-6 py-3 rounded-xl font-bold text-sm transition-all opacity-70 hover:opacity-100">Ø¯ÛŒØ²ÛŒÙ†</button>
                <button onclick="loadResort('darbandsar')" id="btn-darbandsar" class="resort-btn px-6 py-3 rounded-xl font-bold text-sm transition-all opacity-70 hover:opacity-100">Ø¯Ø±Ø¨Ù†Ø¯Ø³Ø±</button>
                <button onclick="loadResort('shemshak')" id="btn-shemshak" class="resort-btn px-6 py-3 rounded-xl font-bold text-sm transition-all opacity-70 hover:opacity-100">Ø´Ù…Ø´Ú©</button>
            </div>

            <!-- Snow Prediction Button -->
            <div class="flex flex-col items-center gap-3">
                <button onclick="findSnowDay()" class="w-20 h-20 rounded-full accent-bg text-white shadow-xl hover:scale-105 transition-transform flex items-center justify-center">
                    <i data-lucide="snowflake" class="w-10 h-10 spin-slow"></i>
                </button>
                <span class="font-bold text-lg">Ú©ÛŒ Ø¨Ø±Ù Ù…ÛŒØ§Ø¯ØŸ</span>
            </div>
        </div>

        <!-- Snow Prediction Result -->
        <div id="snow-prediction" class="hidden max-w-4xl mx-auto mb-8 fade-in"></div>

        <!-- Date Selector -->
        <div id="date-selector-wrapper" class="hidden max-w-4xl mx-auto mb-8 fade-in">
            <div class="glass-card p-2 rounded-2xl overflow-x-auto hide-scroll flex gap-2 justify-start md:justify-center" id="date-selector"></div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden flex-col items-center justify-center py-20">
            <div class="w-12 h-12 border-4 border-current/10 border-t-current rounded-full animate-spin"></div>
            <p class="text-sm font-bold mt-4 opacity-60">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª...</p>
        </div>

        <!-- Weather Cards -->
        <div id="weather-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-7xl mx-auto"></div>

    </main>

    <!-- Footer -->
    <footer class="w-full py-8 text-center text-xs opacity-50 border-t border-current/5">
        <p class="font-mono dir-ltr mb-1">Barf Ko v2.3</p>
        <p>Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©ÛŒâ€ŒØ¨Ø§Ø²Ø§Ù† Ø§ÛŒØ±Ø§Ù†</p>
    </footer>

    <script>
    // ============================================
    // 1. DATE UTILITIES - Using API Dates (Tehran Timezone)
    // ============================================
    
    const WEEKDAYS_EN = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const WEEKDAYS_FA = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];
    
    // Store API dates globally
    let apiDates = [];
    
    function parseApiDate(dateStr) {
        // API returns dates like "2024-12-08"
        const [year, month, day] = dateStr.split('-').map(Number);
        return new Date(year, month - 1, day, 12, 0, 0);
    }
    
    function formatPersianDate(date) {
        return new Intl.DateTimeFormat('fa-IR', {
            day: 'numeric',
            month: 'long'
        }).format(date);
    }
    
    function getDayLabel(dayIndex, date) {
        if (dayIndex === 0) return 'Ø§Ù…Ø±ÙˆØ²';
        if (dayIndex === 1) return 'ÙØ±Ø¯Ø§';
        const dayOfWeek = date.getDay();
        return WEEKDAYS_FA[dayOfWeek];
    }
    
    function updateClock() {
        const now = new Date();
        const formatted = new Intl.DateTimeFormat('fa-IR', {
            timeZone: 'Asia/Tehran',
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        }).format(now);
        document.getElementById('live-clock').textContent = formatted;
    }
    
    // ============================================
    // 2. RESORT DATA
    // ============================================
    
    const RESORTS = {
        tochal: {
            name: 'Ù¾ÛŒØ³Øª ØªÙˆÚ†Ø§Ù„',
            locations: [
                { name: 'Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Û· (Ù‚Ù„Ù‡)', alt: 3740, lat: 35.8853, lon: 51.4150 },
                { name: 'Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Ûµ', alt: 2935, lat: 35.8600, lon: 51.4080 },
                { name: 'Ø§ÛŒØ³ØªÚ¯Ø§Ù‡ Û±', alt: 1900, lat: 35.8195, lon: 51.4100 }
            ]
        },
        dizin: {
            name: 'Ù¾ÛŒØ³Øª Ø¯ÛŒØ²ÛŒÙ†',
            locations: [
                { name: 'Ù‚Ù„Ù‡ (Ø³ÛŒâ€ŒÚ†Ø§Ù„)', alt: 3600, lat: 36.0540, lon: 51.4180 },
                { name: 'Ù¾Ø§Ø±Ú©ÛŒÙ†Ú¯ Ø¨Ø§Ù„Ø§', alt: 3000, lat: 36.0460, lon: 51.4150 },
                { name: 'Ù¾Ø§ÛŒÛŒÙ† (Ù‡ØªÙ„)', alt: 2650, lat: 36.0350, lon: 51.4100 }
            ]
        },
        darbandsar: {
            name: 'Ù¾ÛŒØ³Øª Ø¯Ø±Ø¨Ù†Ø¯Ø³Ø±',
            locations: [
                { name: 'Ù‚Ù„Ù‡', alt: 3570, lat: 36.0180, lon: 51.4650 },
                { name: 'Ù…ÛŒØ§Ù†â€ŒØ±Ø§Ù‡', alt: 3000, lat: 36.0150, lon: 51.4600 },
                { name: 'Ù¾Ø§ÛŒÛŒÙ†', alt: 2600, lat: 36.0100, lon: 51.4550 }
            ]
        },
        shemshak: {
            name: 'Ù¾ÛŒØ³Øª Ø´Ù…Ø´Ú©',
            locations: [
                { name: 'Ù‚Ù„Ù‡', alt: 3050, lat: 36.0220, lon: 51.4890 },
                { name: 'Ù…ÛŒØ§Ù†ÛŒ', alt: 2550, lat: 36.0150, lon: 51.4950 },
                { name: 'Ù¾Ø§ÛŒÛŒÙ†', alt: 2550, lat: 36.0100, lon: 51.4900 }
            ]
        }
    };
    
    // ============================================
    // 3. STATE
    // ============================================
    
    let currentResort = 'tochal';
    let selectedDay = 0;
    let weatherCache = {};
    
    // ============================================
    // 4. API
    // ============================================
    
    async function fetchWeather(lat, lon) {
        const params = [
            'temperature_2m', 'relative_humidity_2m', 'dew_point_2m', 'apparent_temperature',
            'weather_code', 'wind_speed_10m', 'wind_speed_80m', 'wind_direction_10m',
            'wind_gusts_10m', 'visibility', 'cloud_cover', 'cloud_cover_low',
            'cloud_cover_mid', 'cloud_cover_high', 'precipitation', 'rain', 'snowfall',
            'snow_depth', 'pressure_msl', 'cape', 'lifted_index', 'freezing_level_height', 'is_day'
        ].join(',');
        
        const dailyParams = [
            'weather_code', 'temperature_2m_max', 'temperature_2m_min', 'snowfall_sum',
            'precipitation_probability_max', 'precipitation_sum', 'uv_index_max',
            'wind_speed_10m_max', 'wind_gusts_10m_max'
        ].join(',');
        
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=${params}&daily=${dailyParams}&current=temperature_2m,relative_humidity_2m,wind_speed_10m&forecast_days=16&timezone=Asia/Tehran`;
        
        try {
            const res = await fetch(url);
            return await res.json();
        } catch (e) {
            console.error('API Error:', e);
            return null;
        }
    }
    
    // ============================================
    // 5. WEATHER ANALYSIS
    // ============================================
    
    function analyzeWeather(hourlyData, dailyData, dayIndex, altitude) {
        const h = hourlyData;
        const hourIdx = (dayIndex * 24) + 12; // noon
        
        const get = (arr, i, def = 0) => (arr && arr[i] !== undefined) ? arr[i] : def;
        
        // Extract values
        const temp = get(h.temperature_2m, hourIdx);
        const humidity = get(h.relative_humidity_2m, hourIdx);
        const dewPoint = get(h.dew_point_2m, hourIdx);
        const apparentTemp = get(h.apparent_temperature, hourIdx);
        const wind = get(h.wind_speed_10m, hourIdx);
        const wind80m = get(h.wind_speed_80m, hourIdx);
        const windGust = get(h.wind_gusts_10m, hourIdx);
        const windDir = get(h.wind_direction_10m, hourIdx);
        const visibility = get(h.visibility, hourIdx, 10000);
        const cloud = get(h.cloud_cover, hourIdx);
        const cloudLow = get(h.cloud_cover_low, hourIdx);
        const cloudMid = get(h.cloud_cover_mid, hourIdx);
        const cloudHigh = get(h.cloud_cover_high, hourIdx);
        const precipitation = get(h.precipitation, hourIdx);
        const rain = get(h.rain, hourIdx);
        const snowfall = get(h.snowfall, hourIdx);
        const snowDepth = get(h.snow_depth, hourIdx);
        const pressure = get(h.pressure_msl, hourIdx, 1013);
        const cape = get(h.cape, hourIdx);
        const li = get(h.lifted_index, hourIdx);
        const freezeLevel = get(h.freezing_level_height, hourIdx, 3000);
        const isDay = get(h.is_day, hourIdx, 1);
        const uv = get(dailyData.uv_index_max, dayIndex, 0);
        const snowfall24h = get(dailyData.snowfall_sum, dayIndex, 0);
        
        // Wind Analysis
        let windStatus, windLift;
        if (wind <= 20) { windStatus = 'Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„'; windLift = 'Ù‡Ù…Ù‡ Ù„ÛŒÙØªâ€ŒÙ‡Ø§ Ø¨Ø§Ø²'; }
        else if (wind <= 35) { windStatus = 'Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„'; windLift = 'Ù„ÛŒÙØªâ€ŒÙ‡Ø§ Ø¨Ø§Ø²'; }
        else if (wind <= 50) { windStatus = 'Ù†Ø§Ù…Ù†Ø§Ø³Ø¨'; windLift = 'Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù„ÛŒÙØª'; }
        else { windStatus = 'Ø®Ø·Ø±Ù†Ø§Ú©'; windLift = 'ØªØ¹Ø·ÛŒÙ„'; }
        
        // Wind Direction
        const directions = ['Ø´Ù…Ø§Ù„', 'Ø´Ù…Ø§Ù„â€ŒØ´Ø±Ù‚', 'Ø´Ø±Ù‚', 'Ø¬Ù†ÙˆØ¨â€ŒØ´Ø±Ù‚', 'Ø¬Ù†ÙˆØ¨', 'Ø¬Ù†ÙˆØ¨â€ŒØºØ±Ø¨', 'ØºØ±Ø¨', 'Ø´Ù…Ø§Ù„â€ŒØºØ±Ø¨'];
        const windDirName = directions[Math.round(windDir / 45) % 8];
        
        // Visibility
        let visStatus;
        if (visibility >= 10000) visStatus = 'Ø¹Ø§Ù„ÛŒ';
        else if (visibility >= 5000) visStatus = 'Ø®ÙˆØ¨';
        else if (visibility >= 1000) visStatus = 'Ù…ØªÙˆØ³Ø·';
        else visStatus = 'Ø¶Ø¹ÛŒÙ';
        
        // Lens Recommendation
        let lens, lensVLT;
        if (!isDay) { lens = 'Ø´ÙØ§Ù'; lensVLT = '80-95%'; }
        else if (visibility < 1000 || cloud > 80) { lens = 'Ø²Ø±Ø¯'; lensVLT = '50-80%'; }
        else if (cloud > 50) { lens = 'Ù†Ø§Ø±Ù†Ø¬ÛŒ'; lensVLT = '30-50%'; }
        else if (cloud > 20) { lens = 'Ø¨Ø±Ù†Ø²ÛŒ'; lensVLT = '15-30%'; }
        else { lens = 'ØªÛŒØ±Ù‡/Ø¢ÛŒÙ†Ù‡â€ŒØ§ÛŒ'; lensVLT = '5-15%'; }
        
        // Snow Quality
        let snowQuality;
        if (temp < -10 && humidity < 50) snowQuality = 'Ù¾ÙˆØ¯Ø± Ø®Ø´Ú©';
        else if (temp < -5 && humidity < 70) snowQuality = 'Ù¾ÙˆØ¯Ø±';
        else if (temp >= 0) snowQuality = 'Ø¢Ø¨Ú©ÛŒ';
        else if (temp < -10 && wind > 30) snowQuality = 'ÛŒØ®â€ŒØ²Ø¯Ù‡';
        else snowQuality = 'ÙØ´Ø±Ø¯Ù‡';
        
        // CAPE + LI Combined Analysis
        let capeStatus, skiResult;
        if (cape <= 100 && li >= 0) {
            capeStatus = 'Ù¾Ø§ÛŒØ¯Ø§Ø±';
            skiResult = 'Ù¾Ø§ÛŒØ¯Ø§Ø±';
        } else if (cape <= 500 && li >= -3) {
            capeStatus = 'Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ú©Ù…';
            skiResult = 'Ø§Ù…Ú©Ø§Ù† Ø±Ú¯Ø¨Ø§Ø± Ù†Ø§Ú¯Ù‡Ø§Ù†ÛŒ â€“ Ø§Ø­ØªÛŒØ§Ø·';
        } else if (cape <= 1000 && li >= -5) {
            capeStatus = 'Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø±';
            skiResult = 'Ø±Ø¹Ø¯ÙˆØ¨Ø±Ù‚ Ù¾Ø±Ø§Ú©Ù†Ø¯Ù‡ â€“ Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·';
        } else if (cape <= 2500) {
            capeStatus = 'Ø®Ø·Ø±Ù†Ø§Ú©';
            skiResult = 'ØªÙˆÙØ§Ù† Ù‚ÙˆÛŒ â€“ ØµØ¹ÙˆØ¯ Ù…Ù…Ù†ÙˆØ¹';
        } else {
            capeStatus = 'Ø¨Ø³ÛŒØ§Ø± Ø®Ø·Ø±Ù†Ø§Ú©';
            skiResult = 'Ù¾ÛŒØ³Øª Ø¨Ø§ÛŒØ¯ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯';
        }
        
        // Avalanche Risk
        let avalancheRisk;
        if (snowfall24h > 30 || (wind > 40 && snowfall24h > 15)) avalancheRisk = 'Ø¨Ø§Ù„Ø§';
        else if (snowfall24h > 15 || rain > 0) avalancheRisk = 'Ù…ØªÙˆØ³Ø·';
        else avalancheRisk = 'Ú©Ù…';
        
        // Fog Probability
        const dewSpread = temp - dewPoint;
        let fogRisk = dewSpread < 2 ? 'Ø¨Ø§Ù„Ø§' : (dewSpread < 5 ? 'Ù…ØªÙˆØ³Ø·' : 'Ú©Ù…');
        
        // Pressure Condition
        let pressureStatus;
        if (pressure > 1020) pressureStatus = 'Ù¾Ø§ÛŒØ¯Ø§Ø±';
        else if (pressure > 1010) pressureStatus = 'Ù†Ø±Ù…Ø§Ù„';
        else pressureStatus = 'Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø±';
        
        // Final Status
        let status = 'go';
        let statusText = 'Ù…Ù†Ø§Ø³Ø¨';
        let statusColor = 'text-green-600';
        let lightColor = 'bg-green-500';
        let reasons = [];
        
        if (wind > 50 || visibility < 500 || cape > 1000) {
            status = 'stop';
            statusText = 'Ù†Ø§Ù…Ù†Ø§Ø³Ø¨';
            statusColor = 'text-red-600';
            lightColor = 'bg-red-500';
            if (wind > 50) reasons.push('Ø¨Ø§Ø¯ Ø´Ø¯ÛŒØ¯');
            if (visibility < 500) reasons.push('Ø¯ÛŒØ¯ Ø¶Ø¹ÛŒÙ');
            if (cape > 1000) reasons.push('Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¬Ùˆ');
        } else if (wind > 35 || visibility < 2000 || cape > 500 || uv > 8) {
            status = 'caution';
            statusText = 'Ø§Ø­ØªÛŒØ§Ø·';
            statusColor = 'text-amber-600';
            lightColor = 'bg-amber-500';
            if (wind > 35) reasons.push('Ø¨Ø§Ø¯ Ø²ÛŒØ§Ø¯');
            if (visibility < 2000) reasons.push('Ø¯ÛŒØ¯ Ù…ØªÙˆØ³Ø·');
            if (cape > 500) reasons.push('Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ');
            if (uv > 8) reasons.push('UV Ø¨Ø§Ù„Ø§');
        }
        
        // Wind Chill
        const windChill = Math.round(13.12 + 0.6215 * temp - 11.37 * Math.pow(wind, 0.16) + 0.3965 * temp * Math.pow(wind, 0.16));
        
        return {
            temp: Math.round(temp),
            tempMax: Math.round(dailyData.temperature_2m_max[dayIndex]),
            tempMin: Math.round(dailyData.temperature_2m_min[dayIndex]),
            apparentTemp: Math.round(apparentTemp),
            windChill,
            humidity: Math.round(humidity),
            dewPoint: Math.round(dewPoint),
            dewSpread: Math.round(dewSpread),
            wind: Math.round(wind),
            wind80m: Math.round(wind80m),
            windGust: Math.round(windGust),
            windDir: Math.round(windDir),
            windDirName,
            windStatus,
            windLift,
            visibility: Math.round(visibility / 1000 * 10) / 10,
            visStatus,
            cloud: Math.round(cloud),
            cloudLow: Math.round(cloudLow),
            cloudMid: Math.round(cloudMid),
            cloudHigh: Math.round(cloudHigh),
            precipitation: Math.round(precipitation * 10) / 10,
            rain: Math.round(rain * 10) / 10,
            snowfall: Math.round(snowfall * 10) / 10,
            snowfall24h: Math.round(snowfall24h),
            snowDepth: Math.round(snowDepth),
            snowQuality,
            pressure: Math.round(pressure),
            pressureStatus,
            cape: Math.round(cape),
            li: Math.round(li * 10) / 10,
            capeStatus,
            skiResult,
            freezeLevel: Math.round(freezeLevel),
            uv,
            lens,
            lensVLT,
            avalancheRisk,
            fogRisk,
            status,
            statusText,
            statusColor,
            lightColor,
            reasons
        };
    }
    
    // ============================================
    // 6. UI RENDERING
    // ============================================
    
    function renderDateSelector() {
        const container = document.getElementById('date-selector');
        const data = weatherCache[currentResort];
        
        // Get dates from API response (they are in Tehran timezone)
        if (!data || !data[0] || !data[0].daily || !data[0].daily.time) {
            console.error('No API dates available');
            return;
        }
        
        apiDates = data[0].daily.time; // e.g., ["2024-12-08", "2024-12-09", ...]
        
        let html = '';
        for (let i = 0; i < apiDates.length; i++) {
            const date = parseApiDate(apiDates[i]);
            const label = getDayLabel(i, date);
            const persianDate = formatPersianDate(date);
            const isActive = i === selectedDay;
            
            html += `
                <button onclick="selectDay(${i})" 
                    class="flex flex-col items-center px-4 py-2 rounded-xl min-w-[85px] transition-all
                    ${isActive ? 'accent-bg text-white shadow-lg' : 'bg-white/30 hover:bg-white/50'}">
                    <span class="text-xs opacity-80">${label}</span>
                    <span class="text-sm font-bold whitespace-nowrap">${persianDate}</span>
                </button>
            `;
        }
        
        container.innerHTML = html;
        document.getElementById('date-selector-wrapper').classList.remove('hidden');
    }
    
    function renderWeatherCards() {
        const container = document.getElementById('weather-cards');
        const resort = RESORTS[currentResort];
        const data = weatherCache[currentResort];
        
        if (!data) {
            container.innerHTML = '<p class="text-center text-red-500 col-span-3">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>';
            return;
        }
        
        let html = '';
        
        data.forEach((locData, idx) => {
            if (!locData) return;
            
            const loc = resort.locations[idx];
            const analysis = analyzeWeather(locData.hourly, locData.daily, selectedDay, loc.alt);
            
            html += `
                <div class="glass-card rounded-3xl overflow-hidden">
                    
                    <!-- Header with Traffic Light -->
                    <div class="px-5 py-4 flex justify-between items-center bg-white/50 border-b border-current/5">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 rounded-full ${analysis.lightColor} shadow-lg animate-pulse"></div>
                            <span class="font-bold ${analysis.statusColor}">${analysis.statusText}</span>
                        </div>
                        <span class="font-mono dir-ltr text-xs font-bold opacity-60 bg-current/10 px-2 py-1 rounded-full">${loc.alt}m</span>
                    </div>
                    
                    <!-- Main Info -->
                    <div class="p-5 text-center">
                        <h3 class="font-bold opacity-60 mb-2">${loc.name}</h3>
                        <div class="text-6xl font-black dir-ltr mb-2">${analysis.temp}Â°</div>
                        <div class="flex justify-center gap-3 text-sm opacity-50 dir-ltr mb-3">
                            <span>â†“${analysis.tempMin}Â°</span>
                            <span>â†‘${analysis.tempMax}Â°</span>
                        </div>
                        <div class="inline-flex items-center gap-2 bg-current/5 px-3 py-1.5 rounded-lg text-sm">
                            <i data-lucide="thermometer" class="w-4 h-4"></i>
                            <span>Ø§Ø­Ø³Ø§Ø³ Ø¯Ù…Ø§: <span class="dir-ltr font-bold">${analysis.windChill}Â°</span></span>
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-4 gap-px bg-current/5 border-y border-current/5 text-center">
                        <div class="bg-white/40 p-3">
                            <i data-lucide="wind" class="w-4 h-4 mx-auto opacity-50 mb-1"></i>
                            <div class="text-lg font-black dir-ltr text-blue-600">${analysis.wind}</div>
                            <div class="text-xs opacity-60">km/h</div>
                        </div>
                        <div class="bg-white/40 p-3">
                            <i data-lucide="eye" class="w-4 h-4 mx-auto opacity-50 mb-1"></i>
                            <div class="text-lg font-black dir-ltr">${analysis.visibility}</div>
                            <div class="text-xs opacity-60">km</div>
                        </div>
                        <div class="bg-white/40 p-3">
                            <i data-lucide="droplets" class="w-4 h-4 mx-auto opacity-50 mb-1"></i>
                            <div class="text-lg font-black dir-ltr text-cyan-600">${analysis.humidity}%</div>
                            <div class="text-xs opacity-60">Ø±Ø·ÙˆØ¨Øª</div>
                        </div>
                        <div class="bg-white/40 p-3">
                            <i data-lucide="cloud" class="w-4 h-4 mx-auto opacity-50 mb-1"></i>
                            <div class="text-lg font-black dir-ltr text-gray-600">${analysis.cloud}%</div>
                            <div class="text-xs opacity-60">Ø§Ø¨Ø±</div>
                        </div>
                    </div>
                    
                    <!-- Detailed Analysis -->
                    <div class="p-4 space-y-3">
                        
                        <!-- Wind -->
                        <div class="bg-blue-50/50 rounded-xl p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center">
                                    <i data-lucide="wind" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-blue-800">${analysis.windStatus}</div>
                                    <div class="text-xs opacity-60">${analysis.windLift}</div>
                                </div>
                            </div>
                            <div class="text-left dir-ltr">
                                <div class="text-lg font-black text-blue-600">${analysis.wind} km/h</div>
                                <div class="text-xs opacity-50">Gust: ${analysis.windGust}</div>
                            </div>
                        </div>
                        
                        <!-- Lens -->
                        <div class="bg-amber-50/50 rounded-xl p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center">
                                    <i data-lucide="glasses" class="w-5 h-5 text-amber-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-amber-800">Ù„Ù†Ø² ${analysis.lens}</div>
                                    <div class="text-xs opacity-60">UV: ${analysis.uv}</div>
                                </div>
                            </div>
                            <div class="text-left">
                                <div class="text-lg font-black text-amber-600 dir-ltr">${analysis.lensVLT}</div>
                                <div class="text-xs opacity-50">VLT</div>
                            </div>
                        </div>
                        
                        <!-- Snow Quality -->
                        <div class="bg-teal-50/50 rounded-xl p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-teal-100 flex items-center justify-center">
                                    <i data-lucide="snowflake" class="w-5 h-5 text-teal-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-teal-800">${analysis.snowQuality}</div>
                                    <div class="text-xs opacity-60">Ø¨Ø±Ù Û²Û´ Ø³Ø§Ø¹ØªÙ‡: ${analysis.snowfall24h} cm</div>
                                </div>
                            </div>
                            <div class="text-left dir-ltr">
                                <div class="text-lg font-black text-teal-600">${analysis.freezeLevel}m</div>
                                <div class="text-xs opacity-50">ØµÙØ± Ø¯Ø±Ø¬Ù‡</div>
                            </div>
                        </div>
                        
                        <!-- CAPE -->
                        <div class="bg-purple-50/50 rounded-xl p-3">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-purple-100 flex items-center justify-center">
                                        <i data-lucide="zap" class="w-5 h-5 text-purple-600"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-purple-800">${analysis.capeStatus}</div>
                                        <div class="text-xs opacity-60">CAPE: ${analysis.cape} J/kg</div>
                                    </div>
                                </div>
                                <div class="text-left dir-ltr">
                                    <div class="text-lg font-black text-purple-600">${analysis.li}Â°</div>
                                    <div class="text-xs opacity-50">LI</div>
                                </div>
                            </div>
                            <div class="bg-purple-100/50 rounded-lg px-3 py-1.5 text-center">
                                <span class="text-xs font-bold text-purple-700">ğŸ¿ ${analysis.skiResult}</span>
                            </div>
                        </div>
                        
                        <!-- Avalanche -->
                        <div class="bg-red-50/50 rounded-xl p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center">
                                    <i data-lucide="triangle-alert" class="w-5 h-5 text-red-600"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-red-800">Ø±ÛŒØ³Ú© Ø¨Ù‡Ù…Ù†: ${analysis.avalancheRisk}</div>
                                    <div class="text-xs opacity-60">ÙØ´Ø§Ø±: ${analysis.pressure} hPa (${analysis.pressureStatus})</div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Reasons if any -->
                    ${analysis.reasons.length > 0 ? `
                    <div class="px-4 pb-4">
                        <div class="${analysis.status === 'stop' ? 'bg-red-100 border border-red-200' : 'bg-amber-100 border border-amber-200'} rounded-xl p-3 text-center">
                            <div class="flex items-center justify-center gap-2 mb-1">
                                <span class="${analysis.status === 'stop' ? 'text-red-600' : 'text-amber-600'} text-lg">âš ï¸</span>
                                <span class="${analysis.status === 'stop' ? 'text-red-800' : 'text-amber-800'} font-black text-sm">Ø¹Ù„Øª:</span>
                            </div>
                            <span class="${analysis.status === 'stop' ? 'text-red-700' : 'text-amber-700'} text-sm font-bold">${analysis.reasons.join(' â€¢ ')}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                </div>
            `;
        });
        
        container.innerHTML = html;
        lucide.createIcons();
    }
    
    // ============================================
    // 7. ACTIONS
    // ============================================
    
    async function loadResort(key) {
        currentResort = key;
        selectedDay = 0;
        
        // Clear snow prediction
        document.getElementById('snow-prediction').innerHTML = '';
        document.getElementById('snow-prediction').classList.add('hidden');
        
        // Update buttons
        document.querySelectorAll('.resort-btn').forEach(btn => {
            btn.classList.remove('accent-bg', 'text-white', 'shadow-lg');
            btn.classList.add('opacity-70');
        });
        const activeBtn = document.getElementById(`btn-${key}`);
        activeBtn.classList.add('accent-bg', 'text-white', 'shadow-lg');
        activeBtn.classList.remove('opacity-70');
        
        // Show loading
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('loading').classList.add('flex');
        document.getElementById('weather-cards').innerHTML = '';
        
        // Fetch data if not cached
        if (!weatherCache[key]) {
            const resort = RESORTS[key];
            const promises = resort.locations.map(loc => fetchWeather(loc.lat, loc.lon));
            weatherCache[key] = await Promise.all(promises);
        }
        
        // Hide loading
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('loading').classList.remove('flex');
        
        // Render
        renderDateSelector();
        renderWeatherCards();
    }
    
    function selectDay(day) {
        selectedDay = day;
        renderDateSelector();
        renderWeatherCards();
    }
    
    function findSnowDay() {
        const container = document.getElementById('snow-prediction');
        container.innerHTML = `
            <div class="glass-card p-6 rounded-2xl text-center">
                <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto opacity-50"></i>
                <p class="mt-3 font-bold opacity-60">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p>
            </div>
        `;
        container.classList.remove('hidden');
        lucide.createIcons();
        
        setTimeout(() => {
            const data = weatherCache[currentResort];
            if (!data) return;
            
            let bestDay = null;
            let maxSnow = 0;
            let snowData = [];
            
            for (let day = 0; day < 16; day++) {
                let totalSnow = 0;
                const dayData = [];
                
                data.forEach((locData, idx) => {
                    const snow = locData?.daily?.snowfall_sum?.[day] || 0;
                    const prob = locData?.daily?.precipitation_probability_max?.[day] || 0;
                    totalSnow += snow;
                    dayData.push({ idx, snow, prob });
                });
                
                if (totalSnow > maxSnow) {
                    maxSnow = totalSnow;
                    bestDay = day;
                    snowData = dayData;
                }
            }
            
            if (bestDay !== null && maxSnow > 0) {
                // Use API dates
                const dateStr = data[0]?.daily?.time?.[bestDay];
                const date = dateStr ? parseApiDate(dateStr) : new Date();
                
                const label = getDayLabel(bestDay, date);
                const persianDate = formatPersianDate(date);
                const resort = RESORTS[currentResort];
                
                container.innerHTML = `
                    <div class="glass-card p-5 rounded-2xl bg-gradient-to-l from-sky-400 to-sky-500 text-white relative overflow-hidden">
                        
                        <!-- Snow Effect -->
                        <div class="absolute inset-0 overflow-hidden pointer-events-none">
                            <div class="snow-particle"></div>
                            <div class="snow-particle"></div>
                            <div class="snow-particle"></div>
                            <div class="snow-particle"></div>
                            <div class="snow-particle"></div>
                            <div class="snow-particle"></div>
                        </div>
                        
                        <div class="text-center mb-4 relative z-10">
                            <p class="text-white/80 text-sm mb-1">ğŸ‰ Ø±ÙˆØ² Ø¨Ø±ÙÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯!</p>
                            <h3 class="text-xl font-black">${label} - ${persianDate}</h3>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 relative z-10">
                            ${snowData.map(item => {
                                const loc = resort.locations[item.idx];
                                const probColor = item.prob > 70 ? 'bg-green-400' : (item.prob > 40 ? 'bg-amber-400' : 'bg-gray-400');
                                return `
                                    <div class="bg-white/15 backdrop-blur-sm rounded-xl p-3 border border-white/25 text-center">
                                        <div class="font-bold text-sm mb-1">${loc.name}</div>
                                        <div class="text-xs opacity-70 mb-2">${loc.alt}m</div>
                                        <div class="bg-white rounded-lg py-2 mb-2">
                                            <span class="text-2xl font-black text-sky-600">${Math.round(item.snow)}</span>
                                            <span class="text-xs text-gray-600 block">Ø³Ø§Ù†ØªÛŒ</span>
                                        </div>
                                        <div class="${probColor} text-white px-2 py-0.5 rounded-full text-xs font-bold inline-block">${item.prob}%</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="glass-card p-5 rounded-2xl bg-orange-100 text-center">
                        <p class="text-orange-800 font-bold">ØªØ§ Û±Û¶ Ø±ÙˆØ² Ø¢ÛŒÙ†Ø¯Ù‡ Ø¨Ø±Ù Ø³Ù†Ú¯ÛŒÙ†ÛŒ Ù†Ø¯Ø§Ø±ÛŒÙ…!</p>
                        <p class="text-sm opacity-60 mt-1">Ø²Ù…Ø§Ù† Ø®ÙˆØ¨ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ³Øª Ú©ÙˆØ¨ÛŒØ¯Ù‡ Ø§Ø³Øª.</p>
                    </div>
                `;
            }
        }, 1000);
    }
    
    function setTheme(theme) {
        document.body.className = `${theme} flex flex-col`;
        localStorage.setItem('theme', theme);
    }
    
    // ============================================
    // 8. INIT
    // ============================================
    
    window.addEventListener('DOMContentLoaded', () => {
        // Theme
        const savedTheme = localStorage.getItem('theme') || 'theme-snow';
        setTheme(savedTheme);
        
        // Clock
        updateClock();
        setInterval(updateClock, 1000);
        
        // Load default resort
        loadResort('tochal');
        
        // Init icons
        lucide.createIcons();
    });
    </script>
</body>
</html>
