<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برف کو | دستیار هوشمند اسکی</title>
    <meta name="description" content="پیش‌بینی و راهنمای کاربردی اسکی‌بازان - تحلیل دقیق باد، دید و برف">
    
    <!-- Fonts: Vazirmatn -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles & Tailwind Config -->
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Direction Helpers */
        .dir-ltr { direction: ltr; display: inline-block; unicode-bidi: isolate; }
        .num-font { font-feature-settings: "ss01"; }
        
        /* Custom Scrollbar */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Theme Classes */
        .theme-snow {
            --bg-main: #f0f9ff; /* sky-50 */
            --bg-card: rgba(255, 255, 255, 0.8);
            --text-primary: #0f172a; /* slate-900 */
            --text-secondary: #475569; /* slate-600 */
            --accent: #0ea5e9; /* sky-500 */
            --border: #e0f2fe; /* sky-100 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --status-go: #dcfce7;
            --status-caution: #fef3c7;
            --status-stop: #fee2e2;
        }

        .theme-sun {
            --bg-main: #fffbeb; /* amber-50 */
            --bg-card: rgba(255, 255, 255, 0.9);
            --text-primary: #451a03; /* amber-950 */
            --text-secondary: #92400e; /* amber-800 */
            --accent: #f59e0b; /* amber-500 */
            --border: #fef3c7; /* amber-100 */
            --card-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1);
        }

        .theme-night {
            --bg-main: #0f172a; /* slate-900 */
            --bg-card: rgba(30, 41, 59, 0.8); /* slate-800 */
            --text-primary: #f8fafc; /* slate-50 */
            --text-secondary: #94a3b8; /* slate-400 */
            --accent: #818cf8; /* indigo-400 */
            --border: #334155; /* slate-700 */
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* Fix modal text colors for night mode specifically */
        .theme-night #hourly-modal .glass-card, 
        .theme-night #hourly-modal .bg-white\/40,
        .theme-night #hourly-modal .bg-white\/30,
        .theme-night #hourly-modal .bg-white\/50 {
            background-color: rgba(30, 41, 59, 0.9);
            color: #f8fafc;
            border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
        }

        .glass-card {
            background-color: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }

        .accent-text { color: var(--accent); }
        .accent-bg { background-color: var(--accent); }
        
        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        /* Status Colors for Text */
        .text-status-go { color: #15803d; }
        .text-status-caution { color: #b45309; }
        .text-status-stop { color: #b91c1c; }

        /* Status Badges */
        .status-badge-go { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .status-badge-caution { background-color: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .status-badge-nogo { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    </style>
</head>
<body class="theme-snow min-h-screen flex flex-col">

    <!-- Header -->
    <header class="w-full px-6 py-6 flex justify-between items-center max-w-6xl mx-auto">
        <div class="flex items-center gap-3">
            <div class="p-2 rounded-xl accent-bg text-white shadow-lg animate-float">
                <i data-lucide="mountain-snow" class="w-7 h-7"></i>
            </div>
            <div>
                <h1 class="text-3xl font-black tracking-tight text-blue-900 dark:text-blue-100">برف کو</h1>
                <p class="text-xs opacity-80 font-bold text-blue-700 dark:text-blue-300">دستیار هوشمند اسکی‌بازان</p>
            </div>
        </div>

        <!-- Theme Switcher -->
        <div class="flex bg-white/20 backdrop-blur-md rounded-full p-1 border border-current/10">
            <button onclick="setTheme('theme-sun')" class="p-2 rounded-full hover:bg-white/30 transition-colors" aria-label="تم آفتابی">
                <i data-lucide="sun" class="w-5 h-5"></i>
            </button>
            <button onclick="setTheme('theme-snow')" class="p-2 rounded-full hover:bg-white/30 transition-colors" aria-label="تم برفی">
                <i data-lucide="snowflake" class="w-5 h-5"></i>
            </button>
            <button onclick="setTheme('theme-night')" class="p-2 rounded-full hover:bg-white/30 transition-colors" aria-label="تم شب">
                <i data-lucide="moon" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-4 pb-12 max-w-6xl mx-auto w-full relative">
        
        <!-- Modal -->
        <div id="hourly-modal" class="fixed inset-0 z-50 hidden flex-col items-center justify-center bg-black/60 backdrop-blur-sm p-4 fade-in" onclick="closeModal(event)">
            <div class="glass-card w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-3xl p-6 shadow-2xl relative animate-float-up" onclick="event.stopPropagation()">
                <button onclick="closeModal()" class="absolute top-4 left-4 p-2 rounded-full hover:bg-black/5 transition-colors z-10">
                    <i data-lucide="x" class="w-6 h-6 opacity-60"></i>
                </button>
                <div id="modal-content" class="flex flex-col gap-6">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>

        <!-- Resort Selector -->
        <div class="flex flex-col items-center my-8 gap-6">
            <div class="glass-card rounded-2xl p-2 flex flex-wrap justify-center gap-2 shadow-sm">
                <button onclick="loadResort('tochal')" id="btn-tochal" class="resort-btn px-5 py-2 rounded-xl font-bold text-sm transition-all duration-200 bg-transparent opacity-60 hover:opacity-100">
                    توچال
                </button>
                <button onclick="loadResort('dizin')" id="btn-dizin" class="resort-btn px-5 py-2 rounded-xl font-bold text-sm transition-all duration-200 bg-transparent opacity-60 hover:opacity-100">
                    دیزین
                </button>
                <button onclick="loadResort('darbandsar')" id="btn-darbandsar" class="resort-btn px-5 py-2 rounded-xl font-bold text-sm transition-all duration-200 bg-transparent opacity-60 hover:opacity-100">
                    دربندسر
                </button>
                <button onclick="loadResort('shemshak')" id="btn-shemshak" class="resort-btn px-5 py-2 rounded-xl font-bold text-sm transition-all duration-200 bg-transparent opacity-60 hover:opacity-100">
                    شمشک
                </button>
            </div>

            <!-- Magic Button -->
            <div class="flex flex-col items-center gap-4 w-full">
                <button onclick="askWhenSnow()" class="group relative flex items-center justify-center w-20 h-20 rounded-full accent-bg text-white shadow-xl hover:shadow-2xl transition-all hover:-translate-y-1 active:translate-y-0 hover:scale-110 z-10 ring-4 ring-white/30">
                    <div class="absolute inset-0 bg-white/20 rounded-full animate-ping opacity-20"></div>
                    <i data-lucide="snowflake" class="w-10 h-10 animate-[spin_3s_linear_infinite]"></i>
                </button>
                <span class="text-xs font-bold opacity-70 animate-pulse">کی برف میاد؟</span>
            </div>

            <!-- Result Area -->
            <div id="prediction-result" class="w-full max-w-md hidden fade-in mt-4"></div>
        </div>

        <!-- Date Selector -->
        <div id="date-selector-container" class="w-full max-w-4xl mx-auto mb-8 hidden fade-in">
            <div class="glass-card p-2 rounded-2xl overflow-x-auto hide-scroll flex gap-2 justify-start md:justify-center" id="date-selector-list"></div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden flex-col items-center justify-center py-20 opacity-50">
            <i data-lucide="loader-2" class="w-10 h-10 animate-spin mb-4"></i>
            <p class="text-sm animate-pulse">در حال تحلیل داده‌های ماهواره‌ای...</p>
        </div>

        <!-- Content Container -->
        <div id="content-area" class="space-y-12"></div>

        <!-- Guides Section (Separated) -->
        <section id="guides-section" class="w-full max-w-5xl mx-auto mt-16 pt-12 border-t border-current/10">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 rounded-lg bg-blue-100 text-blue-700">
                    <i data-lucide="book-open" class="w-6 h-6"></i>
                </div>
                <h2 class="text-2xl font-black">راهنمای هوشمند برف‌کو</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Lens Guide -->
                <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-400 to-orange-500"></div>
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="glasses" class="w-5 h-5 text-orange-500"></i>
                        راهنمای انتخاب لنز
                    </h3>
                    <div class="space-y-4 text-sm opacity-80">
                        <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-full bg-yellow-400/20 flex items-center justify-center shrink-0">S1</div>
                            <div>
                                <strong class="block text-current">هوای ابری / برفی / مه</strong>
                                <p class="text-xs opacity-70">نور کم است (Flat Light). شما نیاز به کنتراست بالا دارید. لنزهای <span class="text-pink-600 font-bold">صورتی</span> یا <span class="text-yellow-600 font-bold">زرد</span> باعث می‌شوند پستی بلندی‌های برف دیده شوند.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center shrink-0">S3</div>
                            <div>
                                <strong class="block text-current">آفتابی / نیمه ابری</strong>
                                <p class="text-xs opacity-70">نور شدید + بازتاب برف = خطر اشعه UV. لنزهای <span class="text-gray-800 font-bold">تیره</span>، <span class="text-orange-700 font-bold">نارنجی</span> یا <span class="text-blue-600 font-bold">آینه‌ای</span> برای محافظت چشم ضروری هستند.</p>
                            </div>
                        </div>
                         <div class="flex gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-200/50 flex items-center justify-center shrink-0">S0</div>
                            <div>
                                <strong class="block text-current">اسکی شب</strong>
                                <p class="text-xs opacity-70">فقط لنز <span class="font-bold">شفاف (Clear)</span> یا زرد خیلی روشن. لنز تیره در شب خطرناک است.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Wind Guide -->
                <div class="glass-card p-6 rounded-3xl relative overflow-hidden group">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-purple-600"></div>
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="wind" class="w-5 h-5 text-blue-500"></i>
                        تاثیر باد بر اسکی
                    </h3>
                    <div class="space-y-4 text-sm opacity-80">
                        <div class="flex items-start gap-3">
                            <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600 shrink-0 mt-0.5"></i>
                            <div>
                                <strong class="block text-green-700">زیر ۲۰ کیلومتر/ساعت</strong>
                                <p class="text-xs opacity-70">شرایط ایده‌آل. برف کوبیده شده خوب می‌ماند و سردتان نمی‌شود.</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-600 shrink-0 mt-0.5"></i>
                            <div>
                                <strong class="block text-orange-700">۳۰ تا ۵۰ کیلومتر/ساعت</strong>
                                <p class="text-xs opacity-70">باد مخالف حرکت شما را کند می‌کند. سرمای حسی (Wind Chill) زیاد است. لباس بادگیر بپوشید.</p>
                            </div>
                        </div>
                         <div class="flex items-start gap-3">
                            <i data-lucide="x-octagon" class="w-5 h-5 text-red-600 shrink-0 mt-0.5"></i>
                            <div>
                                <strong class="block text-red-700">بالای ۶۰ کیلومتر/ساعت</strong>
                                <p class="text-xs opacity-70">احتمال بسته شدن تله‌کابین و تله‌سیژ. تعادل بهم می‌خورد. اسکی نکنید.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="w-full py-6 px-6 text-center text-xs opacity-50 border-t border-current/5 mt-auto">
        <div class="max-w-4xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <p>© ۱۴۰۳ - برف کو</p>
            <a href="https://github.com/emadewij-collab/snowf" target="_blank" class="flex items-center gap-2 hover:opacity-100 transition-opacity">
                <i data-lucide="github" class="w-3 h-3"></i>
                <span>emadewij-collab/snowf</span>
            </a>
        </div>
    </footer>

    <!-- Application Logic -->
    <script>
        // --- Configuration & Data ---
        
        const RESORTS = {
            tochal: {
                id: 'tochal',
                name: 'پیست اسکی بین‌المللی توچال',
                locations: [
                    { name: 'ایستگاه ۷ (قله)', alt: '3740m', lat: 35.8853, lon: 51.4150 },
                    { name: 'ایستگاه ۵ (دامنه)', alt: '2935m', lat: 35.8600, lon: 51.4080 },
                    { name: 'ایستگاه ۱ (پایین)', alt: '1900m', lat: 35.8195, lon: 51.4100 }
                ]
            },
            dizin: {
                id: 'dizin',
                name: 'پیست اسکی دیزین',
                locations: [
                    { name: 'قله (سی‌چال)', alt: '3600m', lat: 36.0540, lon: 51.4180 },
                    { name: 'پارکینگ بالا', alt: '3000m', lat: 36.0460, lon: 51.4150 },
                    { name: 'هتل (پایین)', alt: '2650m', lat: 36.0350, lon: 51.4100 }
                ]
            },
            darbandsar: {
                id: 'darbandsar',
                name: 'پیست اسکی دربندسر',
                locations: [
                    { name: 'قله', alt: '3570m', lat: 36.0180, lon: 51.4650 },
                    { name: 'میان‌راه', alt: '3000m', lat: 36.0150, lon: 51.4600 },
                    { name: 'پایین', alt: '2600m', lat: 36.0100, lon: 51.4550 }
                ]
            },
            shemshak: {
                id: 'shemshak',
                name: 'پیست اسکی شمشک',
                locations: [
                    { name: 'قله', alt: '3050m', lat: 36.0220, lon: 51.4890 },
                    { name: 'آفتاب (میانی)', alt: '2550m', lat: 36.0150, lon: 51.4950 },
                    { name: 'شب (پایین)', alt: '2550m', lat: 36.0100, lon: 51.4900 }
                ]
            }
        };

        const weatherStore = {};
        let currentSelection = 'tochal'; 
        let selectedDayIndex = 0; 

        // --- Advanced Analytics Logic ---

        function calculateWindChill(temp, speed) {
            if (speed < 4.8 || temp > 10) return temp;
            return Math.round(13.12 + 0.6215 * temp - 11.37 * Math.pow(speed, 0.16) + 0.3965 * temp * Math.pow(speed, 0.16));
        }

        function analyzeSkiConditions(data) {
            const gust = data.gust || data.wind * 1.5; 
            const wind = data.wind;
            const vis = data.visibility || 10000; 
            const cape = data.cape || 0;
            const cloud = data.cloud;
            const temp = data.temp;
            const snowRate = data.snowRate || 0;
            const isDay = data.isDay;
            
            let decision = "شرایط مساعد";
            let statusClass = "status-badge-go";
            let icon = "check-circle-2";
            
            // --- 1. Decision Logic (Persian) ---
            let reasons = [];
            
            if (gust >= 60) {
                decision = "خطرناک / ممنوع";
                reasons.push(`باد لحظه‌ای شدید (${gust} km/h)`);
                statusClass = "status-badge-nogo";
                icon = "x-octagon";
            } else if (vis < 200) {
                decision = "خطرناک / ممنوع";
                reasons.push(`دید افقی بسیار کم (${vis}m)`);
                statusClass = "status-badge-nogo";
                icon = "eye-off";
            } else if (cape >= 1000) {
                decision = "خطرناک (صاعقه)";
                reasons.push(`ناپایداری جوی بالا`);
                statusClass = "status-badge-nogo";
                icon = "zap";
            } else if (gust > 40 || vis < 800 || (snowRate > 2)) {
                decision = "احتیاط کنید";
                if(gust > 40) reasons.push(`باد قابل توجه (${gust} km/h)`);
                if(vis < 800) reasons.push(`کاهش دید (${vis}m)`);
                if(snowRate > 2) reasons.push(`بارش سنگین برف`);
                statusClass = "status-badge-caution";
                icon = "alert-triangle";
            }

            // --- 2. Suggestion Strings (Logic: Condition -> Recommendation) ---
            
            // Lens
            let lensRec = "";
            let uvCondition = "";
            if (isDay === 0) {
                uvCondition = "شب / تاریک";
                lensRec = "لنز شفاف (Clear) یا زرد روشن";
            } else if (vis < 800 || cloud > 90 || snowRate > 0) {
                uvCondition = "نور تخت (Flat Light)";
                lensRec = "لنز صورتی یا زرد (افزایش کنتراست)";
            } else if (cloud < 30) {
                uvCondition = "آفتاب شدید + بازتاب برف";
                lensRec = "لنز تیره، آینه‌ای یا دودی";
            } else {
                uvCondition = "نیمه ابری";
                lensRec = "لنز نارنجی یا فتوکرومیک";
            }

            // Wind
            let windRec = "";
            let windCond = "";
            if (wind < 10) {
                windCond = "باد آرام";
                windRec = "شرایط عالی برای اسکی";
            } else if (wind < 30) {
                windCond = "نسیم ملایم";
                windRec = "تاثیر کمی روی تعادل دارد";
            } else if (wind < 50) {
                windCond = "باد متوسط";
                windRec = "احساس سرما (Wind Chill) + کاهش تعادل";
            } else {
                windCond = "باد شدید/طوفانی";
                windRec = "خطرناک، احتمال توقف تله‌کابین";
            }

            // Checklist Generation (HTML)
            const checklistHTML = `
                <div style="font-family: 'Vazirmatn', sans-serif; direction: rtl; text-align: right; padding: 20px; border: 2px solid #000;">
                    <h1 style="text-align: center; margin-bottom: 5px;">چک‌لیست ایمنی اسکی - برف‌کو</h1>
                    <p style="text-align: center; font-size: 12px; color: #555;">تاریخ: ${new Date().toLocaleDateString('fa-IR')}</p>
                    <div style="border-bottom: 1px dashed #000; margin: 10px 0;"></div>
                    
                    <div style="background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>وضعیت: ${decision}</strong><br/>
                        <small>علت: ${reasons.length ? reasons.join('، ') : 'پایدار'}</small>
                    </div>

                    <h3 style="font-size: 14px; border-bottom: 2px solid #000; display: inline-block;">۱. تجهیزات ضروری</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 5px 0;">▢ کلاه ایمنی (Helmet) <small>- ${wind > 30 ? 'حتما بررسی شود (باد زیاد)' : 'الزامی'}</small></li>
                        <li style="margin: 5px 0;">▢ عینک اسکی <small>- پیشنهاد: ${lensRec}</small></li>
                        <li style="margin: 5px 0;">▢ ضدآفتاب ${isDay && cloud < 50 ? '(ضروری: آفتاب)' : ''}</li>
                        <li style="margin: 5px 0;">▢ لباس لایه‌ای ${temp < -5 ? '(بسیار سرد: ۳ لایه)' : ''}</li>
                    </ul>

                    <div style="margin-top: 20px; font-size: 11px; text-align: center;">
                        ایمنی شما در اولویت است. همیشه پیش از خروج شماره امداد پیست را ذخیره کنید.
                    </div>
                </div>
            `;

            return {
                decision,
                reasons,
                statusClass,
                icon,
                checklistHTML,
                windChill: calculateWindChill(temp, wind),
                logic: {
                    lens: { condition: uvCondition, rec: lensRec },
                    wind: { condition: windCond, rec: windRec }
                }
            };
        }

        function printChecklist(htmlContent) {
            const printWindow = window.open('', '', 'height=600,width=400');
            printWindow.document.write('<html><head><title>Checklist</title>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">');
            printWindow.document.write('</head><body>');
            printWindow.document.write(htmlContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 1000);
        }

        // --- API & Rendering ---

        function getPersianWeekday(dateObj) {
            const days = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه', 'شنبه'];
            return days[dateObj.getDay()];
        }

        function getPersianDateString(offset = 0) {
            const d = new Date();
            d.setDate(d.getDate() + offset);
            return {
                weekday: getPersianWeekday(d),
                fullDate: new Intl.DateTimeFormat('fa-IR', { day: 'numeric', month: 'long' }).format(d),
                iso: d.toISOString().split('T')[0]
            };
        }

        async function fetchWeatherData(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,is_day,snow_depth,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,snowfall_sum,precipitation_probability_max,wind_speed_10m_max&hourly=temperature_2m,weather_code,wind_speed_10m,wind_gusts_10m,is_day,relative_humidity_2m,cloud_cover,visibility,cape,snowfall,wind_direction_10m&forecast_days=7&timezone=Asia%2FTehran`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error("Error fetching weather:", error);
                return null;
            }
        }

        function renderDateSelector() {
            const container = document.getElementById('date-selector-list');
            container.innerHTML = '';
            for(let i=0; i<7; i++) { 
                const dateInfo = getPersianDateString(i);
                const isSelected = i === selectedDayIndex;
                const btn = document.createElement('button');
                btn.onclick = () => selectDate(i);
                btn.className = `flex flex-col items-center justify-center px-4 py-2 rounded-xl min-w-[80px] transition-all ${isSelected ? 'accent-bg text-white shadow-md scale-105' : 'bg-transparent opacity-60 hover:opacity-100 hover:bg-white/10'}`;
                btn.innerHTML = `
                    <span class="text-sm font-bold mb-1">${i === 0 ? 'امروز' : dateInfo.weekday}</span>
                    <span class="text-xs font-mono opacity-80">${dateInfo.fullDate}</span>
                `;
                container.appendChild(btn);
            }
            document.getElementById('date-selector-container').classList.remove('hidden');
        }

        function selectDate(index) {
            selectedDayIndex = index;
            renderDateSelector(); 
            renderResortCards(currentSelection);
        }

        function getWeatherStatus(code) {
            const map = {
                0: { text: 'آسمان صاف', icon: 'sun' },
                1: { text: 'کمی ابری', icon: 'cloud-sun' },
                2: { text: 'نیمه ابری', icon: 'cloud' },
                3: { text: 'ابری', icon: 'cloud' },
                45: { text: 'مه‌آلود', icon: 'cloud-fog' },
                48: { text: 'مه یخ‌زده', icon: 'cloud-fog' },
                51: { text: 'نم‌نم باران', icon: 'cloud-drizzle' },
                53: { text: 'باران ملایم', icon: 'cloud-rain' },
                55: { text: 'باران شدید', icon: 'cloud-rain' },
                61: { text: 'باران', icon: 'cloud-rain' },
                63: { text: 'باران', icon: 'cloud-rain' },
                65: { text: 'باران سیل‌آسا', icon: 'cloud-rain-wind' },
                71: { text: 'برف سبک', icon: 'snowflake' },
                73: { text: 'برف متوسط', icon: 'snowflake' },
                75: { text: 'برف سنگین', icon: 'snowflake' },
                77: { text: 'دانه برف', icon: 'snowflake' },
                80: { text: 'رگبار', icon: 'cloud-rain' },
                81: { text: 'رگبار شدید', icon: 'cloud-rain' },
                82: { text: 'رگبار سیل‌آسا', icon: 'cloud-rain' },
                85: { text: 'رگبار برف', icon: 'snowflake' },
                86: { text: 'کولاک برف', icon: 'snowflake' }
            };
            return map[code] || { text: 'نامشخص', icon: 'help-circle' };
        }

        function createCardHTML(locationName, alt, data, dayIndex, resortKey, locIndex) {
            if (!data) return `<div class="glass-card p-6 rounded-2xl text-center">خطا در دریافت اطلاعات</div>`;

            const daily = data.daily;
            const hourly = data.hourly;
            const currentHour = new Date().getHours();
            
            // Temps
            const isToday = dayIndex === 0;
            let mainTemp = isToday ? Math.round(data.current.temperature_2m) : Math.round(daily.temperature_2m_max[dayIndex]);
            const minTemp = Math.round(daily.temperature_2m_min[dayIndex]);
            const maxTemp = Math.round(daily.temperature_2m_max[dayIndex]);

            // Weather
            const weatherCode = daily.weather_code[dayIndex];
            const weather = getWeatherStatus(weatherCode);
            
            // Sample Hour (Noon) for Analysis
            const sampleHourIndex = (dayIndex * 24) + 12;
            const analysisData = {
                temp: hourly.temperature_2m[sampleHourIndex] || mainTemp,
                wind: hourly.wind_speed_10m[sampleHourIndex] || 0,
                gust: hourly.wind_gusts_10m ? hourly.wind_gusts_10m[sampleHourIndex] : 0,
                visibility: hourly.visibility ? hourly.visibility[sampleHourIndex] : 10000,
                cape: hourly.cape ? hourly.cape[sampleHourIndex] : 0,
                cloud: hourly.cloud_cover[sampleHourIndex] || 0,
                snowRate: hourly.snowfall[sampleHourIndex] || 0,
                isDay: 1
            };
            
            const analysis = analyzeSkiConditions(analysisData);

            // Grid
            const targetHours = [9, 12, 15];
            const timeLabels = ['صبح', 'ظهر', 'عصر'];
            let gridHTML = '';
            targetHours.forEach((hour, idx) => {
                const hIdx = (dayIndex * 24) + hour;
                if (hIdx >= hourly.time.length) return;
                const tTemp = Math.round(hourly.temperature_2m[hIdx]);
                const tCode = hourly.weather_code[hIdx];
                const tIcon = getWeatherStatus(tCode).icon;
                
                gridHTML += `
                    <button onclick="openHourlyDetails('${resortKey}', ${locIndex}, ${hIdx}, '${timeLabels[idx]}')" class="flex flex-col justify-center items-center p-2 bg-white/30 rounded-xl border border-current/5 shadow-sm hover:bg-white/50 transition-all">
                        <span class="text-[10px] font-bold opacity-60 mb-1">${timeLabels[idx]}</span>
                        <i data-lucide="${tIcon}" class="w-5 h-5 my-1 opacity-80"></i>
                        <span class="text-lg font-black dir-ltr ${tTemp < 0 ? 'text-blue-600' : 'text-orange-600'}">${tTemp}°</span>
                    </button>
                `;
            });

            return `
                <div class="glass-card p-0 rounded-[2rem] flex flex-col relative overflow-hidden group transition-all duration-300 hover:shadow-xl h-full">
                    
                    <!-- Header Status Strip -->
                    <div class="${analysis.statusClass} p-4 pb-8 flex justify-between items-start relative z-0">
                        <div class="z-10">
                            <h3 class="font-black text-xl tracking-tight">${locationName}</h3>
                            <span class="text-[10px] font-bold uppercase tracking-wider opacity-60 bg-white/30 px-2 py-0.5 rounded-full dir-ltr">${alt}</span>
                        </div>
                        <div class="flex items-center gap-1 z-10 bg-white/50 px-3 py-1 rounded-xl shadow-sm">
                            <i data-lucide="${analysis.icon}" class="w-4 h-4"></i>
                            <span class="text-xs font-black">${analysis.decision}</span>
                        </div>
                    </div>

                    <!-- Main Stats (Overlapping Header) -->
                    <div class="px-6 -mt-6 relative z-10 flex justify-between items-end">
                        <div class="glass-card bg-white p-3 rounded-2xl shadow-md flex flex-col items-center min-w-[80px]">
                            <span class="text-4xl font-black dir-ltr text-current leading-none">${mainTemp}°</span>
                            <div class="flex gap-2 mt-1 text-[10px] font-bold opacity-50 dir-ltr">
                                <span>L:${minTemp}</span>
                                <span>H:${maxTemp}</span>
                            </div>
                        </div>
                         <div class="flex flex-col items-end mb-2">
                            <i data-lucide="${weather.icon}" class="w-10 h-10 accent-text animate-float"></i>
                            <span class="text-xs font-bold opacity-80">${weather.text}</span>
                        </div>
                    </div>

                    <!-- Smart Reasoning (The "Why") -->
                    <div class="p-4 space-y-2">
                        <!-- Wind Logic -->
                        <div onclick="openHourlyDetails('${resortKey}', ${locIndex}, ${sampleHourIndex}, 'ظهر')" class="cursor-pointer bg-blue-50/50 border border-blue-100 p-3 rounded-xl flex items-start gap-3 hover:bg-blue-50 transition-colors">
                            <div class="mt-0.5 p-1.5 bg-blue-100 text-blue-600 rounded-lg">
                                <i data-lucide="wind" class="w-4 h-4"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-blue-800 opacity-70 mb-0.5">وضعیت باد: ${analysisData.wind} km/h</span>
                                <span class="text-xs font-black text-blue-900 leading-tight">${analysis.logic.wind.condition} ← <span class="font-normal opacity-80">${analysis.logic.wind.rec}</span></span>
                            </div>
                        </div>

                        <!-- Lens Logic -->
                        <div onclick="openHourlyDetails('${resortKey}', ${locIndex}, ${sampleHourIndex}, 'ظهر')" class="cursor-pointer bg-orange-50/50 border border-orange-100 p-3 rounded-xl flex items-start gap-3 hover:bg-orange-50 transition-colors">
                            <div class="mt-0.5 p-1.5 bg-orange-100 text-orange-600 rounded-lg">
                                <i data-lucide="glasses" class="w-4 h-4"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-orange-800 opacity-70 mb-0.5">وضعیت نور: ${analysis.logic.lens.condition}</span>
                                <span class="text-xs font-black text-orange-900 leading-tight">پیشنهاد ← <span class="font-normal opacity-80">${analysis.logic.lens.rec}</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Hourly Grid -->
                    <div class="px-4 pb-4 grid grid-cols-3 gap-3 mt-auto">
                        ${gridHTML}
                    </div>
                    
                    <!-- Footer Action -->
                    <button onclick="openHourlyDetails('${resortKey}', ${locIndex}, ${sampleHourIndex}, 'ظهر')" class="w-full py-3 bg-current/5 hover:bg-current/10 text-xs font-bold transition-all text-center border-t border-current/5">
                        مشاهده جزئیات کامل و تحلیل دقیق
                    </button>
                </div>
            `;
        }

        async function renderResortCards(resortKey) {
            const container = document.getElementById(`cards-${resortKey}`);
            const resort = RESORTS[resortKey];
            if(!weatherStore[resortKey]) return;

            container.innerHTML = '';
            weatherStore[resortKey].forEach((data, index) => {
                const loc = resort.locations[index];
                container.innerHTML += createCardHTML(loc.name, loc.alt, data, selectedDayIndex, resortKey, index);
            });
            lucide.createIcons();
        }

        function openHourlyDetails(resortKey, locIndex, hourlyIndex, timeLabel) {
            const data = weatherStore[resortKey][locIndex];
            const h = data.hourly;
            
            const rawData = {
                temp: h.temperature_2m[hourlyIndex],
                wind: h.wind_speed_10m[hourlyIndex],
                gust: h.wind_gusts_10m ? h.wind_gusts_10m[hourlyIndex] : 0,
                visibility: h.visibility ? h.visibility[hourlyIndex] : 10000,
                cape: h.cape ? h.cape[hourlyIndex] : 0,
                cloud: h.cloud_cover[hourlyIndex],
                snowRate: h.snowfall[hourlyIndex],
                isDay: h.is_day[hourlyIndex]
            };

            const analysis = analyzeSkiConditions(rawData);
            const locationName = RESORTS[resortKey].locations[locIndex].name;
            const resortName = RESORTS[resortKey].name;

            const modal = document.getElementById('hourly-modal');
            const content = document.getElementById('modal-content');

            content.innerHTML = `
                <div class="text-center border-b border-current/10 pb-4">
                    <h3 class="text-xl font-black">${resortName}</h3>
                    <p class="text-sm opacity-60">${locationName} - ساعت ${timeLabel}</p>
                </div>

                <!-- Safety Dashboard -->
                <div class="flex flex-col gap-3">
                    <div class="flex items-center justify-between p-3 rounded-xl ${analysis.statusClass}">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${analysis.icon}" class="w-6 h-6"></i>
                            <span class="font-black text-lg">${analysis.decision}</span>
                        </div>

                    </div>
                </div>

                <!-- Detailed Analysis Logic (The Guide) -->
                <div class="bg-white/60 p-4 rounded-xl border border-current/10">
                    <h4 class="text-sm font-bold mb-3 flex items-center gap-2">
                        <i data-lucide="brain-circuit" class="w-4 h-4 text-purple-600"></i>
                        <span>چرا این وضعیت اعلام شد؟</span>
                    </h4>
                    <div class="space-y-3 text-xs">
                         <!-- Wind Logic -->
                        <div class="flex gap-3">
                            <div class="w-1 bg-blue-400 rounded-full"></div>
                            <div>
                                <strong class="block opacity-80 mb-0.5">تحلیل باد (${analysis.logic.wind.condition})</strong>
                                <p class="opacity-70 leading-relaxed">${analysis.logic.wind.rec}</p>
                            </div>
                        </div>
                         <!-- Light Logic -->
                        <div class="flex gap-3">
                            <div class="w-1 bg-amber-400 rounded-full"></div>
                            <div>
                                <strong class="block opacity-80 mb-0.5">تحلیل نور (${analysis.logic.lens.condition})</strong>
                                <p class="opacity-70 leading-relaxed">لنز پیشنهادی: ${analysis.logic.lens.rec}</p>
                            </div>
                        </div>
                         <!-- Rule -->
                        ${analysis.reasons.length > 0 ? `
                        <div class="bg-red-50 p-2 rounded text-red-800 mt-2">
                             <strong class="block mb-1">قوانین فعال شده:</strong>
                             <ul class="list-disc list-inside opacity-80">${analysis.reasons.map(r => `<li>${r}</li>`).join('')}</ul>
                        </div>` : ''}
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function closeModal(event) {
            if (event && event.target.id !== 'hourly-modal' && !event.target.closest('button')) return;
            const modal = document.getElementById('hourly-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        async function renderResort(resortKey) {
            const container = document.getElementById('content-area');
            const resort = RESORTS[resortKey];
            
            const section = document.createElement('section');
            section.className = 'mb-12 animate-float-up';
            section.innerHTML = `
                <div class="flex items-center gap-2 mb-6 px-2">
                    <div class="w-1 h-6 accent-bg rounded-full"></div>
                    <h2 class="text-2xl font-bold tracking-tight">${resort.name}</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="cards-${resortKey}"></div>
            `;
            container.innerHTML = ''; 
            container.appendChild(section);

            renderDateSelector();
            const cardsContainer = document.getElementById(`cards-${resortKey}`);
            
            if (!weatherStore[resortKey]) weatherStore[resortKey] = [];
            const promises = resort.locations.map(loc => fetchWeatherData(loc.lat, loc.lon));
            const results = await Promise.all(promises);

            results.forEach((data, index) => {
                if(data) weatherStore[resortKey][index] = data;
            });
            renderResortCards(resortKey);
        }

        async function loadResort(selection) {
            currentSelection = selection;
            selectedDayIndex = 0; 
            
            const loading = document.getElementById('loading');
            const resultArea = document.getElementById('prediction-result');
            const buttons = document.querySelectorAll('.resort-btn');

            resultArea.innerHTML = ''; 
            resultArea.classList.add('hidden');
            loading.classList.remove('hidden');
            loading.classList.add('flex');
            
            buttons.forEach(btn => {
                btn.classList.remove('accent-bg', 'text-white', 'opacity-100', 'shadow-lg');
                btn.classList.add('bg-transparent', 'opacity-60');
            });
            const activeBtn = document.getElementById(`btn-${selection}`);
            if(activeBtn) {
                activeBtn.classList.add('accent-bg', 'text-white', 'opacity-100', 'shadow-lg');
                activeBtn.classList.remove('bg-transparent', 'opacity-60');
            }

            await renderResort(selection);

            loading.classList.add('hidden');
            loading.classList.remove('flex');
        }

        function askWhenSnow() {
            const resultDiv = document.getElementById('prediction-result');
            resultDiv.innerHTML = `<div class="flex justify-center p-4"><i data-lucide="loader" class="animate-spin"></i></div>`;
            resultDiv.classList.remove('hidden');
            lucide.createIcons();

            setTimeout(() => {
                let bestSnowEvent = null;
                const rKey = currentSelection;
                const resortData = weatherStore[rKey];
                
                if (!resortData) return;

                resortData.forEach((data, locIndex) => {
                    if (!data || !data.daily) return;
                    const locName = RESORTS[rKey].locations[locIndex].name;
                    const resortName = RESORTS[rKey].name;

                    const daysCount = data.daily.time.length;
                    for (let i = 0; i < daysCount; i++) {
                        const snowAmount = data.daily.snowfall_sum[i];
                        const prob = data.daily.precipitation_probability_max[i];

                        if (snowAmount > 0) {
                            if (!bestSnowEvent || 
                                i < bestSnowEvent.dayIndex || 
                                (i === bestSnowEvent.dayIndex && snowAmount > bestSnowEvent.amount)) {
                                bestSnowEvent = {
                                    dayIndex: i,
                                    amount: snowAmount,
                                    prob: prob,
                                    resort: resortName,
                                    location: locName
                                };
                            }
                        }
                    }
                });

                if (bestSnowEvent) {
                    let dayName;
                    if (bestSnowEvent.dayIndex === 0) dayName = 'همین امروز';
                    else if (bestSnowEvent.dayIndex === 1) dayName = 'فردا';
                    else if (bestSnowEvent.dayIndex === 2) dayName = 'پس‌فردا';
                    else dayName = `${bestSnowEvent.dayIndex} روز دیگه`;
                    
                    const dateStr = getPersianDateString(bestSnowEvent.dayIndex).fullDate;

                    resultDiv.innerHTML = `
                        <div class="glass-card p-6 rounded-2xl border-2 border-blue-400/30 bg-blue-50/50 mt-4 relative overflow-hidden text-center">
                            <div class="absolute -left-4 -top-4 w-32 h-32 bg-blue-400/20 rounded-full blur-xl"></div>
                            <div class="relative z-10 flex flex-col items-center gap-3">
                                <h4 class="text-2xl font-black text-blue-900">پیدا شد: ${dayName}!</h4>
                                <span class="text-xs font-bold bg-white/50 px-2 py-0.5 rounded text-blue-800">${dateStr}</span>
                                <div class="flex flex-col items-center gap-1 mt-2">
                                    <p class="text-sm opacity-80">
                                        در <strong>${bestSnowEvent.resort}</strong>
                                    </p>
                                    <div class="flex items-center gap-4 mt-2">
                                        <div class="flex flex-col items-center">
                                            <span class="font-black text-3xl text-blue-700 dir-ltr">${bestSnowEvent.amount} cm</span>
                                            <span class="text-[10px] font-bold opacity-60">برف تازه</span>
                                        </div>
                                        <div class="w-px h-8 bg-blue-900/10"></div>
                                        <div class="flex flex-col items-center">
                                             <span class="font-black text-xl text-blue-700 dir-ltr">${bestSnowEvent.prob}%</span>
                                             <span class="text-[10px] font-bold opacity-60">احتمال</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="glass-card p-4 rounded-xl border border-orange-200 bg-orange-50/50 mt-4 text-center">
                            <p class="text-sm text-orange-800 font-bold">فعلاً خبری نیست!</p>
                            <p class="text-xs opacity-70 mt-1">تا ۷ روز آینده در ${RESORTS[currentSelection].name} بارش برف پیش‌بینی نشده.</p>
                        </div>
                    `;
                }
                lucide.createIcons();
            }, 800);
        }

        function setTheme(themeName) {
            document.body.className = `${themeName} min-h-screen flex flex-col`;
        }

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadResort('tochal');
        });

    </script>
</body>
</html>
